<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>FIDO2 / WebAuthn Panel</title>
  </head>
  <body>
    <section
        th:fragment="fido2Panel(visible)"
        id="protocol-panel-fido2"
        class="protocol-panel"
        data-protocol-panel="fido2"
        aria-labelledby="protocol-tab-fido2"
        th:attr="hidden=${visible == null || !visible} ? 'hidden' : null, aria-hidden=${visible == null || !visible} ? 'true' : null"
      >
      <div class="stack-lg">
        <div
            class="ocra-mode-toggle"
            data-testid="fido2-panel-tabs"
            role="tablist"
            aria-label="FIDO2 interaction modes"
          >
          <button
              type="button"
              class="mode-pill mode-pill--active"
              id="fido2-panel-tab-evaluate"
              data-testid="fido2-panel-tab-evaluate"
              data-fido2-panel-target="evaluate"
              role="tab"
              aria-selected="true"
              aria-controls="fido2-evaluate-panel"
            >
            Evaluate
          </button>
          <button
              type="button"
              class="mode-pill"
              id="fido2-panel-tab-replay"
              data-testid="fido2-panel-tab-replay"
              data-fido2-panel-target="replay"
              role="tab"
              aria-selected="false"
              aria-controls="fido2-replay-panel"
            >
            Replay
          </button>
        </div>

        <section
            id="fido2-evaluate-panel"
            class="card-shell"
            data-testid="fido2-evaluate-panel"
            data-fido2-panel="evaluate"
            role="tabpanel"
            aria-labelledby="fido2-panel-tab-evaluate"
          >
          <div class="card-shell__body section-columns">
            <div class="stack-lg">
              <h2 class="section-title" id="fido2-evaluate-heading">Evaluate a WebAuthn assertion</h2>

              <fieldset
                  class="mode-toggle"
                  data-testid="fido2-evaluate-mode-toggle"
                  data-mode="inline"
                >
                <legend>Choose evaluation mode</legend>
                <div class="mode-option">
                  <input
                    type="radio"
                    id="fido2EvaluateModeInline"
                    name="fido2EvaluateMode"
                    value="inline"
                    data-testid="fido2-evaluate-mode-select-inline"
                    aria-describedby="fido2EvaluateModeInlineHint"
                    checked="checked"
                  />
                  <label for="fido2EvaluateModeInline">Inline parameters</label>
                  <p id="fido2EvaluateModeInlineHint" class="hint">
                    Provide credential metadata and assertion payloads without storing them first.
                  </p>
                </div>
                <div class="mode-option">
                  <input
                    type="radio"
                    id="fido2EvaluateModeStored"
                    name="fido2EvaluateMode"
                    value="stored"
                    data-testid="fido2-evaluate-mode-select-stored"
                    aria-describedby="fido2EvaluateModeStoredHint"
                  />
                  <label for="fido2EvaluateModeStored">Stored credential</label>
                  <p id="fido2EvaluateModeStoredHint" class="hint">
                    Select a stored WebAuthn credential and supply assertion payloads for verification.
                  </p>
                </div>
              </fieldset>

              <section
                  class="stack-md"
                  data-mode-section="inline"
                  data-testid="fido2-evaluate-inline-section"
                  aria-label="Inline WebAuthn evaluation form"
                  hidden="hidden"
                  aria-hidden="true"
                >
                <form
                    data-testid="fido2-inline-form"
                    class="evaluation-form"
                    th:attr="data-evaluate-endpoint=${fido2InlineEvaluateEndpoint}"
                  >
                  <input type="hidden" name="_csrf" th:value="${csrfToken}" />
                  <script
                      type="application/json"
                      id="fido2-inline-vectors"
                      th:utext="${fido2InlineVectorsJson}"
                    ></script>
                  <div class="field-grid field-grid--two-column">
                    <div class="field-group">
                      <label for="fido2InlineRpId">Relying party ID</label>
                      <input
                          id="fido2InlineRpId"
                          name="relyingPartyId"
                          type="text"
                          value="example.org"
                          autocomplete="off"
                        />
                    </div>
                    <div class="field-group">
                      <label for="fido2InlineOrigin">Origin</label>
                      <input
                          id="fido2InlineOrigin"
                          name="origin"
                          type="text"
                          value="https://example.org"
                          autocomplete="off"
                        />
                    </div>
                  </div>
                  <div class="field-grid">
                    <div class="field-group">
                      <label for="fido2InlineCredentialId">Credential ID (Base64URL)</label>
                      <textarea
                          id="fido2InlineCredentialId"
                          name="credentialId"
                          rows="1"
                          spellcheck="false"
                        ></textarea>
                    </div>
                    <div class="field-group">
                      <label for="fido2InlineAlgorithm">Algorithm</label>
                      <select
                          id="fido2InlineAlgorithm"
                          name="algorithm"
                          data-testid="fido2-inline-algorithm"
                        >
                        <option value="ES256" selected="selected">ES256</option>
                        <option value="ES384">ES384</option>
                        <option value="ES512">ES512</option>
                        <option value="RS256">RS256</option>
                        <option value="PS256">PS256</option>
                        <option value="EdDSA">EdDSA</option>
                      </select>
                    </div>
                  </div>
                  <div class="field-grid">
                    <div class="field-group" data-testid="fido2-inline-counter-group">
                      <label for="fido2InlineCounter">Signature counter</label>
                      <input
                          id="fido2InlineCounter"
                          name="signatureCounter"
                          type="number"
                          min="0"
                          step="1"
                          value=""
                          readonly="readonly"
                          data-testid="fido2-inline-counter-input"
                        />
                      <div class="field-group field-group--checkbox">
                        <input
                            type="checkbox"
                            id="fido2InlineCounterAuto"
                            checked="checked"
                            data-testid="fido2-inline-counter-toggle"
                          />
                        <label for="fido2InlineCounterAuto">Use current Unix seconds</label>
                      </div>
                      <p class="hint" data-testid="fido2-inline-counter-hint">
                        Last autofill: awaiting snapshot.
                      </p>
                      <div class="button-row">
                        <button
                            type="button"
                            class="button-secondary"
                            data-testid="fido2-inline-counter-reset"
                          >
                          Reset to now
                        </button>
                      </div>
                    </div>
                    <div class="field-group field-group--checkbox">
                      <input
                          type="checkbox"
                          id="fido2InlineUvRequired"
                          name="userVerificationRequired"
                          value="true"
                        />
                      <label for="fido2InlineUvRequired">User verification required</label>
                    </div>
                    <div class="field-group">
                      <label for="fido2InlineChallenge">Challenge (Base64URL)</label>
                      <textarea
                          id="fido2InlineChallenge"
                          name="challenge"
                          rows="3"
                          spellcheck="false"
                        ></textarea>
                    </div>
                  </div>
                  <div class="field-group">
                    <label for="fido2InlinePrivateKey">Authenticator private key (JWK or PEM/PKCS#8)</label>
                    <textarea
                        id="fido2InlinePrivateKey"
                        name="privateKey"
                        rows="6"
                        spellcheck="false"
                      ></textarea>
                    <p class="hint">
                      Provide the authenticator's private key in JWK (recommended) or PEM/PKCS#8 form.
                    </p>
                  </div>
                  <div class="inline-preset" data-testid="fido2-inline-preset">
                    <label for="fido2InlineSampleSelect">Load a generator preset</label>
                    <select
                        id="fido2InlineSampleSelect"
                        data-testid="fido2-inline-sample-select"
                        disabled="disabled"
                      >
                      <option value="">Select a preset</option>
                      <th:block th:each="vector : ${fido2InlineVectors}">
                        <option
                            th:value="${vector.key()}"
                            th:text="${vector.label()}"
                            th:attr="data-algorithm=${vector.algorithm()},data-credential-name=${vector.credentialName()}">
                        </option>
                      </th:block>
                    </select>
                    <p class="hint">
                      Select an algorithm preset to auto-fill reproducible inline generator data.
                    </p>
                  </div>
                  <div class="button-row">
                    <button
                        type="button"
                        class="button-primary"
                        data-testid="fido2-evaluate-inline-submit"
                      >
                      Generate inline assertion
                    </button>
                  </div>
                </form>
              </section>

              <section
                  class="stack-md"
                  data-mode-section="stored"
                  data-testid="fido2-evaluate-stored-section"
                  aria-label="Stored WebAuthn evaluation form"
                >
                <form
                    data-testid="fido2-stored-form"
                    class="evaluation-form"
                    th:attr="data-evaluate-endpoint=${fido2StoredEvaluateEndpoint},data-credentials-endpoint=${fido2CredentialsEndpoint},data-seed-endpoint=${fido2SeedEndpoint},data-sample-endpoint=${fido2StoredSampleEndpoint}"
                  >
                  <input type="hidden" name="_csrf" th:value="${csrfToken}" />
                  <script
                      type="application/json"
                      id="fido2-seed-definitions"
                      th:utext="${fido2SeedDefinitionsJson}"
                    ></script>
                  <div
                      class="seed-actions stack-sm"
                      data-testid="fido2-seed-actions"
                      hidden="hidden"
                      aria-hidden="true"
                    >
                    <button
                        type="button"
                        class="button-secondary"
                        data-testid="fido2-seed-credentials"
                      >
                      Seed sample credential
                    </button>
                    <p class="hint">
                      Populate the registry with demo WebAuthn credentials if no entries are available.
                    </p>
                    <p
                        class="hint"
                        hidden="hidden"
                        aria-hidden="true"
                        data-testid="fido2-seed-status"
                      ></p>
                  </div>
                  <div class="stack-sm">
                    <button
                        type="button"
                        class="button-secondary"
                        data-testid="fido2-stored-load-sample"
                      >
                      Load preset challenge &amp; key
                    </button>
                    <p class="hint">
                      Prefill the challenge and authenticator private key for the selected credential.
                    </p>
                  </div>
                  <div class="field-group">
                    <label for="fido2StoredCredentialId">Stored credential</label>
                    <select
                        id="fido2StoredCredentialId"
                        name="credentialId"
                        required="required"
                        disabled="disabled"
                        data-testid="fido2-stored-credential-select"
                      >
                      <option value="">Select a stored credential</option>
                    </select>
                  </div>
                  <div class="field-grid field-grid--two-column">
                    <div class="field-group">
                      <label for="fido2StoredRpId">Relying party ID</label>
                      <input
                          id="fido2StoredRpId"
                          name="relyingPartyId"
                          type="text"
                          value="example.org"
                          autocomplete="off"
                        />
                    </div>
                    <div class="field-group">
                      <label for="fido2StoredOrigin">Origin</label>
                      <input
                          id="fido2StoredOrigin"
                          name="origin"
                          type="text"
                          value="https://example.org"
                          autocomplete="off"
                        />
                    </div>
                  </div>
                  <div class="field-grid">
                    <div class="field-group">
                      <label for="fido2StoredChallenge">Challenge (Base64URL)</label>
                      <textarea
                          id="fido2StoredChallenge"
                          name="challenge"
                          rows="3"
                          spellcheck="false"
                        ></textarea>
                    </div>
                  </div>
                  <div class="field-group">
                    <label for="fido2StoredPrivateKey">Authenticator private key (JWK or PEM/PKCS#8)</label>
                    <textarea
                        id="fido2StoredPrivateKey"
                        name="privateKey"
                        rows="6"
                        spellcheck="false"
                      ></textarea>
                    <p class="hint">
                      Provide the authenticator's private key in JWK (recommended) or PEM/PKCS#8 form.
                    </p>
                  </div>
                  <div class="field-grid">
                    <div class="field-group">
                      <label for="fido2StoredCounter">Signature counter override</label>
                      <input
                          id="fido2StoredCounter"
                          name="signatureCounter"
                          type="number"
                          min="0"
                          step="1"
                          placeholder="Use stored counter"
                        />
                    </div>
                    <div class="field-group field-group--checkbox">
                      <input
                          type="checkbox"
                          id="fido2StoredUvRequired"
                          name="userVerificationRequired"
                          value="true"
                          data-null-when-unchecked="true"
                        />
                      <label for="fido2StoredUvRequired">Override user verification requirement</label>
                    </div>
                  </div>
                  <div class="button-row">
                    <button
                        type="button"
                        class="button-primary"
                        data-testid="fido2-evaluate-stored-submit"
                      >
                      Generate stored assertion
                    </button>
                  </div>
                </form>
              </section>
            </div>

            <div class="status-column stack-md">
              <section
                  class="result-panel"
                  data-testid="fido2-stored-result"
                  aria-live="polite"
                >
                <h3 class="section-title">Generated assertion</h3>
                <div class="button-row">
                  <button
                      type="button"
                      class="button-secondary"
                      data-testid="fido2-copy-assertion"
                      disabled="disabled"
                    >
                    Copy JSON
                  </button>
                  <button
                      type="button"
                      class="button-secondary"
                      data-testid="fido2-download-assertion"
                      disabled="disabled"
                    >
                    Download JSON
                  </button>
                </div>
                <pre class="code-block" data-testid="fido2-generated-assertion-json">Awaiting submission.</pre>
                <div class="telemetry" data-testid="fido2-generated-assertion-metadata">
                  Telemetry pending (sanitized).
                </div>
              </section>

              <section
                  class="result-panel"
                  data-testid="fido2-inline-result"
                  aria-live="polite"
                >
                <h3 class="section-title">Generated assertion</h3>
                <pre class="code-block" data-testid="fido2-inline-generated-json">Awaiting submission.</pre>
                <div
                    class="alert alert-error"
                    data-testid="fido2-inline-error"
                    hidden="hidden"
                    aria-hidden="true"
                  ></div>
              </section>
            </div>
          </div>
        </section>

        <section
            id="fido2-replay-panel"
            class="card-shell"
            data-testid="fido2-replay-panel"
            data-fido2-panel="replay"
            role="tabpanel"
            aria-labelledby="fido2-panel-tab-replay"
            hidden="hidden"
            aria-hidden="true"
          >
          <div class="card-shell__body section-columns">
            <div class="stack-lg">
              <h2 class="section-title" id="fido2-replay-heading">Replay a WebAuthn assertion</h2>

              <fieldset
                  class="mode-toggle"
                  data-testid="fido2-replay-mode-toggle"
                  data-mode="inline"
                >
                <legend>Choose replay mode</legend>
                <div class="mode-option">
                  <input
                    type="radio"
                    id="fido2ReplayModeInline"
                    name="fido2ReplayMode"
                    value="inline"
                    data-testid="fido2-replay-mode-select-inline"
                    aria-describedby="fido2ReplayModeInlineHint"
                    checked="checked"
                  />
                  <label for="fido2ReplayModeInline">Inline parameters</label>
                  <p id="fido2ReplayModeInlineHint" class="hint">
                    Provide credential metadata and assertion payloads directly for diagnostics.
                  </p>
                </div>
                <div class="mode-option">
                  <input
                    type="radio"
                    id="fido2ReplayModeStored"
                    name="fido2ReplayMode"
                    value="stored"
                    data-testid="fido2-replay-mode-select-stored"
                    aria-describedby="fido2ReplayModeStoredHint"
                  />
                  <label for="fido2ReplayModeStored">Stored credential</label>
                  <p id="fido2ReplayModeStoredHint" class="hint">
                    Select a stored credential and replay an assertion without mutating state.
                  </p>
                </div>
              </fieldset>

              <section
                  class="stack-md"
                  data-replay-section="inline"
                  data-testid="fido2-replay-inline-section"
                  aria-label="Inline WebAuthn replay form"
                  hidden="hidden"
                  aria-hidden="true"
                >
                <form
                    data-testid="fido2-replay-inline-form"
                    class="evaluation-form"
                    th:attr="data-replay-endpoint=${fido2ReplayEndpoint}"
                  >
                  <input type="hidden" name="_csrf" th:value="${csrfToken}" />
                  <input id="fido2ReplayRpId" type="hidden" name="relyingPartyId" />
                  <div class="field-grid">
                    <div class="field-group">
                      <label for="fido2ReplayInlineCredentialId">Credential ID (Base64URL)</label>
                      <textarea
                          id="fido2ReplayInlineCredentialId"
                          name="credentialId"
                          rows="1"
                          spellcheck="false"
                        ></textarea>
                    </div>
                    <div class="field-group">
                      <label for="fido2ReplayInlinePublicKey">Public key (COSE, Base64URL)</label>
                      <textarea
                          id="fido2ReplayInlinePublicKey"
                          name="publicKey"
                          rows="4"
                          spellcheck="false"
                        ></textarea>
                    </div>
                  </div>
                  <div class="field-grid field-grid--two-column">
                    <div class="field-group">
                      <label for="fido2ReplayInlineRpId">Relying party ID</label>
                      <input
                          id="fido2ReplayInlineRpId"
                          name="relyingPartyId"
                          type="text"
                          value="example.org"
                          autocomplete="off"
                        />
                    </div>
                    <div class="field-group">
                      <label for="fido2ReplayInlineOrigin">Origin</label>
                      <input
                          id="fido2ReplayInlineOrigin"
                          name="origin"
                          type="text"
                          value="https://example.org"
                          autocomplete="off"
                        />
                    </div>
                  </div>
                  <div class="field-grid">
                    <div class="field-group">
                      <label for="fido2ReplayInlineAlgorithm">Algorithm</label>
                      <select
                          id="fido2ReplayInlineAlgorithm"
                          name="algorithm"
                          data-testid="fido2-replay-inline-algorithm"
                        >
                        <option value="ES256" selected="selected">ES256</option>
                        <option value="ES384">ES384</option>
                        <option value="ES512">ES512</option>
                        <option value="RS256">RS256</option>
                        <option value="PS256">PS256</option>
                        <option value="EdDSA">EdDSA</option>
                      </select>
                    </div>
                    <div class="field-group">
                      <label for="fido2ReplayInlineCounter">Signature counter</label>
                      <input
                          id="fido2ReplayInlineCounter"
                          name="signatureCounter"
                          type="number"
                          min="0"
                          step="1"
                          value="0"
                        />
                    </div>
                    <div class="field-group field-group--checkbox">
                      <input
                          type="checkbox"
                          id="fido2ReplayInlineUvRequired"
                          name="userVerificationRequired"
                          value="true"
                        />
                      <label for="fido2ReplayInlineUvRequired">User verification required</label>
                    </div>
                  </div>
                  <textarea
                      id="fido2ReplayInlineChallenge"
                      name="expectedChallenge"
                      hidden="hidden"
                    ></textarea>
                  <textarea id="fido2ReplayInlineClientData" name="clientData" hidden="hidden"></textarea>
                  <textarea
                      id="fido2ReplayInlineAuthenticatorData"
                      name="authenticatorData"
                      hidden="hidden"
                    ></textarea>
                  <textarea id="fido2ReplayInlineSignature" name="signature" hidden="hidden"></textarea>
                  <div class="inline-preset" data-testid="fido2-replay-inline-preset">
                    <label for="fido2ReplayInlineSampleSelect">Load a sample vector</label>
                    <select
                        id="fido2ReplayInlineSampleSelect"
                        data-testid="fido2-replay-inline-sample-select"
                        disabled="disabled"
                      >
                      <option value="">Select a sample</option>
                    </select>
                    <p class="hint">
                      Presets auto-fill inline replay inputs with curated assertion payloads for diagnostics.
                    </p>
                  </div>
                  <div class="button-row">
                    <button
                        type="button"
                        class="button-primary"
                        data-testid="fido2-replay-inline-submit"
                      >
                      Replay inline assertion
                    </button>
                  </div>
                </form>
              </section>

              <section
                  class="stack-md"
                  data-replay-section="stored"
                  data-testid="fido2-replay-stored-section"
                  aria-label="Stored WebAuthn replay form"
                >
                <form
                    data-testid="fido2-replay-form"
                    class="evaluation-form"
                    th:attr="data-replay-endpoint=${fido2ReplayEndpoint},data-credentials-endpoint=${fido2CredentialsEndpoint},data-sample-endpoint=${fido2StoredSampleEndpoint}"
                  >
                  <input type="hidden" name="_csrf" th:value="${csrfToken}" />
                  <div class="field-grid">
                    <div class="field-group">
                      <label for="fido2ReplayCredentialId">Stored credential</label>
                      <select
                          id="fido2ReplayCredentialId"
                          name="credentialId"
                          disabled="disabled"
                          data-testid="fido2-replay-credential-select"
                        >
                        <option value="">Select a stored credential</option>
                      </select>
                    </div>
                    <div class="field-group">
                      <label for="fido2ReplayOrigin">Origin</label>
                      <input
                          id="fido2ReplayOrigin"
                          name="origin"
                          type="text"
                          value="https://example.org"
                        />
                    </div>
                  </div>
                  <textarea id="fido2ReplayChallenge" name="expectedChallenge" hidden="hidden"></textarea>
                  <textarea id="fido2ReplayClientData" name="clientData" hidden="hidden"></textarea>
                  <textarea
                      id="fido2ReplayAuthenticatorData"
                      name="authenticatorData"
                      hidden="hidden"
                    ></textarea>
                  <textarea id="fido2ReplaySignature" name="signature" hidden="hidden"></textarea>
                  <div class="button-row">
                    <button
                        type="button"
                        class="button-primary"
                        data-testid="fido2-replay-stored-submit"
                      >
                      Replay stored assertion
                    </button>
                  </div>
                </form>
              </section>
            </div>

            <div class="status-column stack-md">
              <section class="result-panel" data-testid="fido2-replay-result" aria-live="polite">
                <h3 class="section-title">Replay result</h3>
                <p>
                  Outcome:
                  <span data-testid="fido2-replay-status">pending</span>
                  (<span data-testid="fido2-replay-reason">awaiting submission</span>)
                </p>
                <p class="hint" data-testid="fido2-replay-message">Awaiting submission.</p>
                <div class="telemetry" data-testid="fido2-replay-telemetry">
                  Telemetry pending (sanitized).
                </div>
              </section>
              <section
                  class="result-panel"
                  data-testid="fido2-replay-inline-result"
                  aria-live="polite"
                  hidden="hidden"
                  aria-hidden="true"
                >
                <h3 class="section-title">Inline replay result</h3>
                <p>
                  Outcome:
                  <span data-testid="fido2-replay-inline-status">pending</span>
                  (<span data-testid="fido2-replay-inline-reason">awaiting submission</span>)
                </p>
                <p class="hint" data-testid="fido2-replay-inline-message">Awaiting submission.</p>
                <div class="telemetry" data-testid="fido2-replay-inline-telemetry">
                  Telemetry pending (sanitized).
                </div>
              </section>
            </div>
          </div>
        </section>
      </div>
    </section>
  </body>
</html>
