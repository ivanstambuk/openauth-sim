<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>OCRA Replay</title>
    <link rel="stylesheet" th:href="@{/ui/console/console.css}" />
  </head>
  <body>
    <main aria-labelledby="replay-heading">
      <h1 id="replay-heading">OCRA Replay Console</h1>
      <p class="summary">
        Verify historical OTP submissions against stored credentials or inline secrets. Payloads are
        forwarded to the REST replay endpoint and sanitized telemetry is surfaced for audit trails.
      </p>

      <section
        class="card-shell"
        aria-labelledby="replay-section-title"
        data-testid="ocra-replay-panel"
        th:fragment="ocraReplayPanel(visible)"
        th:attr="hidden=${visible == null || visible} ? null : 'hidden', aria-hidden=${visible == null || visible} ? null : 'true'"
      >
        <div class="section-columns">
          <div>
            <h2 id="replay-section-title" class="section-title">Replay an OTP</h2>
            <form
                action="#"
                aria-describedby="replay-heading"
                class="evaluation-form"
                novalidate="novalidate"
                data-testid="ocra-replay-form"
                th:attr="data-replay-endpoint=${verificationEndpoint},data-credentials-endpoint=${credentialsEndpoint},data-sample-template=${credentialSampleEndpoint},data-telemetry-endpoint=${telemetryEndpoint},data-csrf=${csrfToken}"
              >
              <input type="hidden" name="_csrf" th:value="${csrfToken}" />

              <fieldset class="mode-toggle" aria-describedby="replay-mode-help">
                <legend>Choose replay mode</legend>
                <div class="mode-option">
                  <input
                    type="radio"
                    id="replayModeInline"
                    name="replayMode"
                    value="inline"
                    checked
                  />
                  <label for="replayModeInline">Inline parameters</label>
                  <p id="inline-mode-hint" class="hint">
                    Provide the suite, shared secret, and OTP context directly for ad-hoc verification.
                  </p>
                </div>
                <div class="mode-option">
                  <input
                    type="radio"
                    id="replayModeStored"
                    name="replayMode"
                    value="stored"
                  />
                  <label for="replayModeStored">Stored credential</label>
                  <p id="stored-mode-hint" class="hint">
                    Select an existing credential and supply the original OTP context. Secrets remain hidden.
                  </p>
                </div>
              </fieldset>

              <section
                id="replay-stored-section"
                data-replay-section="stored"
                aria-labelledby="stored-mode-hint"
                hidden="hidden"
                aria-hidden="true"
              >
                <div class="field-grid">
                  <div>
                    <label for="replayCredentialId">Stored credential</label>
                    <select id="replayCredentialId" data-stored-required="true" disabled>
                      <option value="">Loading credentials…</option>
                    </select>
                    <p class="hint" data-testid="replay-credential-status">
                      Fetching credential inventory…
                    </p>
                  </div>
                </div>
                <p
                  class="hint credential-status"
                  data-testid="replay-sample-status"
                  hidden="hidden"
                  aria-hidden="true"
                ></p>
              </section>

              <div
                class="inline-preset"
                data-replay-inline-preset
              >
                <label for="replayPolicyPreset">Load a sample vector</label>
                <select
                  id="replayPolicyPreset"
                  name="replayPolicyPreset"
                  data-testid="replay-inline-policy-select"
                >
                  <option value="">Select a sample</option>
                  <option
                    th:each="preset : ${policyPresets}"
                    th:value="${preset.key}"
                    th:text="${preset.label}"
                  ></option>
                </select>
                <p class="hint">
                  Selecting a preset auto-fills the inline fields with illustrative data.
                </p>
              </div>

              <div class="field-grid">
                <div>
                  <label for="replayOtp">One-time password</label>
                  <input
                    id="replayOtp"
                    name="otp"
                    type="text"
                    inputmode="numeric"
                    autocomplete="one-time-code"
                    required
                  />
                </div>
                <div>
                  <label for="replayChallenge">Challenge</label>
                  <input id="replayChallenge" name="challenge" type="text" required />
                </div>
              </div>

              <section
                id="replay-inline-section"
                data-replay-section="inline"
                aria-labelledby="inline-mode-hint"
              >
                <div class="field-grid">
                  <div>
                    <label for="replaySuite">OCRA suite</label>
                    <input id="replaySuite" data-inline-required="true" type="text" disabled />
                  </div>
                  <div>
                    <label for="replaySharedSecretHex">Shared secret (hex)</label>
                    <textarea
                      id="replaySharedSecretHex"
                      data-inline-required="true"
                      rows="3"
                      spellcheck="false"
                      disabled
                    ></textarea>
                    <p class="hint">Secrets are sanitized before rendering telemetry details.</p>
                  </div>
                </div>
              </section>

              <div class="advanced-actions">
                <button
                  type="button"
                  class="button-link"
                  data-testid="replay-advanced-toggle"
                  aria-expanded="false"
                  aria-controls="replay-advanced"
                >
                  Show advanced context
                </button>
              </div>

              <section
                id="replay-advanced"
                class="advanced-panel"
                data-testid="ocra-replay-advanced-panel"
                data-open="false"
                aria-hidden="true"
              >
                <div class="field-grid">
                  <div>
                    <label for="replaySessionHex">Session (hex)</label>
                    <textarea id="replaySessionHex" rows="3" spellcheck="false"></textarea>
                  </div>
                  <div>
                    <label for="replayCounter">Counter</label>
                    <input id="replayCounter" type="number" min="0" step="1" />
                  </div>
                  <div>
                    <label for="replayTimestampHex">Timestamp (hex)</label>
                    <input id="replayTimestampHex" type="text" />
                  </div>
                  <div>
                    <label for="replayClientChallenge">Client challenge</label>
                    <input id="replayClientChallenge" type="text" />
                  </div>
                  <div>
                    <label for="replayServerChallenge">Server challenge</label>
                    <input id="replayServerChallenge" type="text" />
                  </div>
                  <div>
                    <label for="replayPinHashHex">PIN hash (hex)</label>
                    <input id="replayPinHashHex" type="text" />
                  </div>
                </div>
              </section>

              <div class="form-actions">
                <button type="submit" class="button-primary" data-testid="ocra-replay-submit">
                  Verify OTP
                </button>
              </div>
            </form>
          </div>

          <aside class="result-aside">
            <section
              class="result-panel"
              data-testid="ocra-replay-result"
              hidden
              aria-hidden="true"
              aria-labelledby="replay-result-heading"
            >
              <div class="result-header">
                <h3 id="replay-result-heading">Replay result</h3>
                <span data-testid="ocra-replay-status" class="status-badge">—</span>
              </div>
              <dl class="result-metadata" data-testid="ocra-replay-telemetry">
                <div class="result-row">
                  <dt>Reason Code</dt>
                  <dd data-testid="ocra-replay-reason-code">—</dd>
                </div>
                <div class="result-row">
                  <dt>Outcome</dt>
                  <dd data-testid="ocra-replay-outcome">—</dd>
                </div>
              </dl>
              <div
                class="result-message"
                data-result-message
                hidden
                aria-hidden="true"
              ></div>
              <p
                class="hint result-message__hint"
                data-result-hint
                hidden
                aria-hidden="true"
              ></p>
            </section>
          </aside>
        </div>
      </section>
    </main>

    <script
      id="ocra-replay-policy-presets"
      type="application/json"
      th:fragment="ocraReplayPresetData"
      th:utext="${policyPresetJson}"
    ></script>

    <script th:inline="javascript" th:fragment="ocraReplayScripts">
      (function () {
        var doc = document;
        var form = doc.querySelector('[data-testid="ocra-replay-form"]');
        if (!form) {
          window.__ocraReplayReady = true;
          return;
        }

        var fetchDelegate = function (endpoint, options) {
          if (typeof window.fetch !== 'function') {
            return Promise.reject(new Error('Fetch API unavailable'));
          }
          return window.fetch(endpoint, options);
        };

        var modeRadios = form.querySelectorAll('input[name="replayMode"]');
        var storedSection = doc.getElementById('replay-stored-section');
        var inlineSection = doc.getElementById('replay-inline-section');
        var credentialSelect = doc.getElementById('replayCredentialId');
        var credentialStatus = doc.querySelector('[data-testid="replay-credential-status"]');
        var inlineFields = doc.querySelectorAll('[data-inline-required]');
        var storedFields = doc.querySelectorAll('[data-stored-required]');
        var otpInput = doc.getElementById('replayOtp');
        var challengeInput = doc.getElementById('replayChallenge');
        var sessionInput = doc.getElementById('replaySessionHex');
        var counterInput = doc.getElementById('replayCounter');
        var timestampInput = doc.getElementById('replayTimestampHex');
        var clientChallengeInput = doc.getElementById('replayClientChallenge');
        var serverChallengeInput = doc.getElementById('replayServerChallenge');
        var pinHashInput = doc.getElementById('replayPinHashHex');
        var suiteInput = doc.getElementById('replaySuite');
        var secretInput = doc.getElementById('replaySharedSecretHex');
        var submitButton = form.querySelector('[data-testid="ocra-replay-submit"]');
        var advancedToggle = doc.querySelector('[data-testid="replay-advanced-toggle"]');
        var advancedPanel = doc.querySelector('[data-testid="ocra-replay-advanced-panel"]');
        var resultPanel = doc.querySelector('[data-testid="ocra-replay-result"]');
        var statusBadge = doc.querySelector('[data-testid="ocra-replay-status"]');
        var reasonCodeValue = doc.querySelector('[data-testid="ocra-replay-reason-code"]');
        var outcomeValue = doc.querySelector('[data-testid="ocra-replay-outcome"]');
        var credentialsEndpoint = form.getAttribute('data-credentials-endpoint');
        var verificationEndpoint = form.getAttribute('data-replay-endpoint');
        var telemetryEndpoint = form.getAttribute('data-telemetry-endpoint');
        var csrfToken = form.getAttribute('data-csrf');
        var presetSelect = doc.getElementById('replayPolicyPreset');
        var presetContainer = doc.querySelector('[data-replay-inline-preset]');
        var presetSource = doc.getElementById('ocra-replay-policy-presets');
        var credentialCache = null;
        var credentialPromise = null;
        var sampleStatus = doc.querySelector('[data-testid="replay-sample-status"]');
        var sampleEndpointTemplate = form.getAttribute('data-sample-template');
        var sampleCache = Object.create(null);
        var sampleRequests = Object.create(null);
        var activeCredentialId = '';
        var NO_SAMPLE = { unavailable: true };
        window.__ocraReplayLastResponse = null;
        window.__ocraReplayLastPayload = null;
        var presetMap = Object.create(null);
        var lastBroadcastReplayMode = null;
        var initialReplayMode = window.__ocraReplayInitialMode;
        if (!initialReplayMode) {
          try {
            var replaySearchParams = new window.URLSearchParams(window.location.search || '');
            var queryMode = replaySearchParams.get('mode');
            if (queryMode && (queryMode === 'stored' || queryMode === 'inline')) {
              initialReplayMode = queryMode;
            }
          } catch (error) {
            initialReplayMode = null;
          }
        }

        if (presetSource && presetSource.textContent) {
          try {
            var presetPayload = JSON.parse(presetSource.textContent);
            if (Array.isArray(presetPayload)) {
              presetPayload.forEach(function (entry) {
                if (
                  entry &&
                  typeof entry.key === 'string' &&
                  entry.sample &&
                  typeof entry.sample === 'object'
                ) {
                  presetMap[entry.key] = entry.sample;
                }
              });
            }
          } catch (error) {
            // ignore malformed preset payloads
          }
        }

        window.__ocraReplayPresets = presetMap;

        function normalizeBoolean(value, fallback) {
          if (typeof value === 'boolean') {
            return value ? 'true' : 'false';
          }
          if (typeof value === 'string') {
            var trimmed = value.trim().toLowerCase();
            if (trimmed === 'true') {
              return 'true';
            }
            if (trimmed === 'false') {
              return 'false';
            }
          }
          return fallback || 'false';
        }

        function fallback(value, defaultValue) {
          if (value === null || value === undefined) {
            return defaultValue;
          }
          if (typeof value === 'string' && value.trim() === '') {
            return defaultValue;
          }
          return value;
        }

        function currentMode() {
          var selected = form && form.querySelector('input[name="replayMode"]:checked');
          return selected ? selected.value : 'inline';
        }

        function sampleEndpointFor(credentialId) {
          if (!sampleEndpointTemplate || !credentialId) {
            return null;
          }
          return sampleEndpointTemplate.replace(
            '{credentialId}',
            encodeURIComponent(credentialId)
          );
        }

        function resetSampleUI() {
          if (!sampleStatus) {
            return;
          }
          sampleStatus.textContent = '';
          sampleStatus.classList.remove('credential-status--error', 'credential-status--warning');
          sampleStatus.setAttribute('hidden', 'hidden');
          sampleStatus.setAttribute('aria-hidden', 'true');
        }

        function setSampleStatus(message, severity) {
          if (!sampleStatus) {
            return;
          }
          if (!message) {
            sampleStatus.textContent = '';
            sampleStatus.classList.remove('credential-status--error', 'credential-status--warning');
            sampleStatus.setAttribute('hidden', 'hidden');
            sampleStatus.setAttribute('aria-hidden', 'true');
            return;
          }
          sampleStatus.textContent = message;
          sampleStatus.classList.remove('credential-status--error', 'credential-status--warning');
          if (severity === 'error') {
            sampleStatus.classList.add('credential-status--error');
          } else if (severity === 'warning') {
            sampleStatus.classList.add('credential-status--warning');
          }
          sampleStatus.removeAttribute('hidden');
          sampleStatus.setAttribute('aria-hidden', 'false');
        }

        function updateSampleVisibility() {
          if (currentMode() !== 'stored') {
            resetSampleUI();
            return;
          }
          var hasCredentials = Array.isArray(credentialCache) && credentialCache.length > 0;
          if (!hasCredentials) {
            resetSampleUI();
          }
        }

        function sampleAvailable(sample) {
          return (
            sample &&
            sample !== NO_SAMPLE &&
            typeof sample === 'object' &&
            sample.context &&
            typeof sample.context === 'object'
          );
        }

        function ensureSample(credentialId) {
          if (!credentialId) {
            return Promise.resolve(NO_SAMPLE);
          }
          if (Object.prototype.hasOwnProperty.call(sampleCache, credentialId)) {
            return Promise.resolve(sampleCache[credentialId]);
          }
          if (sampleRequests[credentialId]) {
            return sampleRequests[credentialId];
          }
          var endpoint = sampleEndpointFor(credentialId);
          if (!endpoint) {
            sampleCache[credentialId] = NO_SAMPLE;
            return Promise.resolve(NO_SAMPLE);
          }
          var request = fetchDelegate(endpoint, {
            method: 'GET',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin',
          })
            .then(function (response) {
              return response.text().then(function (text) {
                return { ok: response.ok, body: parseJson(text) };
              });
            })
            .then(function (result) {
              delete sampleRequests[credentialId];
              if (result.ok && result.body && typeof result.body === 'object') {
                sampleCache[credentialId] = result.body;
                return result.body;
              }
              sampleCache[credentialId] = NO_SAMPLE;
              return NO_SAMPLE;
            })
            .catch(function () {
              delete sampleRequests[credentialId];
              sampleCache[credentialId] = NO_SAMPLE;
              return NO_SAMPLE;
            });
          sampleRequests[credentialId] = request;
          return request;
        }

        function setBusy(isBusy) {
          if (!submitButton) {
            return;
          }
          submitButton.disabled = !!isBusy;
          submitButton.setAttribute('aria-busy', isBusy ? 'true' : 'false');
        }

        function show(element) {
          if (!element) {
            return;
          }
          element.removeAttribute('hidden');
          element.setAttribute('aria-hidden', 'false');
        }

        function hide(element) {
          if (!element) {
            return;
          }
          element.setAttribute('hidden', 'hidden');
          element.setAttribute('aria-hidden', 'true');
        }

        function hideResultPanel(panel) {
          if (!panel) {
            return;
          }
          if (window.ResultCard && typeof window.ResultCard.hidePanel === 'function') {
            window.ResultCard.hidePanel(panel);
            return;
          }
          hide(panel);
        }

        function showResultPanel(panel) {
          if (!panel) {
            return;
          }
          if (window.ResultCard && typeof window.ResultCard.showPanel === 'function') {
            window.ResultCard.showPanel(panel);
            return;
          }
          show(panel);
        }

        function resetResultPanel(panel) {
          if (!panel) {
            return;
          }
          if (window.ResultCard && typeof window.ResultCard.resetMessage === 'function') {
            window.ResultCard.resetMessage(panel);
            return;
          }
          var messageNode = panel.querySelector('[data-result-message]');
          if (messageNode) {
            messageNode.textContent = '';
            messageNode.setAttribute('hidden', 'hidden');
            messageNode.setAttribute('aria-hidden', 'true');
          }
          var hintNode = panel.querySelector('[data-result-hint]');
          if (hintNode) {
            hintNode.textContent = '';
            hintNode.setAttribute('hidden', 'hidden');
            hintNode.setAttribute('aria-hidden', 'true');
          }
        }

        function showResultError(panel, message, hint) {
          if (!panel) {
            return;
          }
          var text = typeof message === 'string' && message.trim().length > 0
            ? message.trim()
            : 'Unable to process replay request.';
          var options = {};
          if (typeof hint === 'string' && hint.trim().length > 0) {
            options.hint = hint.trim();
          }
          if (window.ResultCard && typeof window.ResultCard.showMessage === 'function') {
            window.ResultCard.showMessage(panel, text, 'error', options);
          } else {
            var messageNode = panel.querySelector('[data-result-message]');
            if (messageNode) {
              messageNode.textContent = text;
              messageNode.removeAttribute('hidden');
              messageNode.setAttribute('aria-hidden', 'false');
            }
            var hintNode = panel.querySelector('[data-result-hint]');
            if (hintNode) {
              if (options.hint) {
                hintNode.textContent = options.hint;
                hintNode.removeAttribute('hidden');
                hintNode.setAttribute('aria-hidden', 'false');
              } else {
                hintNode.textContent = '';
                hintNode.setAttribute('hidden', 'hidden');
                hintNode.setAttribute('aria-hidden', 'true');
              }
            }
          }
          showResultPanel(panel);
        }

        function clearPanels() {
          hideResultPanel(resultPanel);
          resetResultDisplay();
        }

        function enableFields(collection, enabled, requiredAttr) {
          collection.forEach(function (element) {
            if (!element) {
              return;
            }
            if (enabled) {
              element.removeAttribute('disabled');
              if (requiredAttr) {
                element.setAttribute('required', 'required');
              }
            } else {
              element.setAttribute('disabled', 'disabled');
              if (requiredAttr) {
                element.removeAttribute('required');
              }
              if (typeof element.value === 'string') {
                element.value = '';
              }
            }
          });
        }

        function syncMode(options) {
          options = options || {};
          var selected = form.querySelector('input[name="replayMode"]:checked');
          var mode = selected ? selected.value : 'inline';
          if (mode === 'stored') {
            show(storedSection);
            hide(inlineSection);
            enableFields(inlineFields, false, true);
            enableFields(storedFields, true, true);
            if (presetSelect) {
              presetSelect.value = '';
              presetSelect.setAttribute('disabled', 'disabled');
            }
            if (presetContainer) {
              hide(presetContainer);
            }
            fetchStoredCredentials();
            updateSampleVisibility();
            handleCredentialSelection();
            if (!options.skipFocus && credentialSelect && !credentialSelect.disabled) {
              credentialSelect.focus();
            }
          } else {
            hide(storedSection);
            show(inlineSection);
            enableFields(inlineFields, true, true);
            enableFields(storedFields, false, true);
            if (presetSelect) {
              presetSelect.removeAttribute('disabled');
            }
            if (presetContainer) {
              show(presetContainer);
            }
            if (!options.skipFocus && suiteInput) {
              suiteInput.focus();
            }
            updateSampleVisibility();
          }
          broadcastReplayModeChange(mode, {
            replace: options.replace === true,
            force: options.force === true,
          });
        }

        function broadcastReplayModeChange(mode, options) {
          if (!mode) {
            return;
          }
          if (lastBroadcastReplayMode === mode && !(options && options.force)) {
            return;
          }
          lastBroadcastReplayMode = mode;
          try {
            var detail = { mode: mode };
            if (options && options.replace) {
              detail.replace = true;
            }
            window.dispatchEvent(
              new window.CustomEvent('operator:ocra-replay-mode-changed', { detail: detail })
            );
          } catch (error) {
            if (window.console && typeof window.console.warn === 'function') {
              window.console.warn('Unable to broadcast OCRA replay mode change', error);
            }
          }
        }

        function parseJson(text) {
          if (!text) {
            return null;
          }
          try {
            return JSON.parse(text);
          } catch (err) {
            return null;
          }
        }

        function fetchStoredCredentials() {
          if (!credentialsEndpoint) {
            return;
          }
          if (credentialCache) {
            return;
          }
          if (credentialPromise) {
            return;
          }
          credentialPromise = fetchDelegate(credentialsEndpoint, {
            method: 'GET',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin',
          })
            .then(function (response) {
              return response.text().then(function (text) {
                return { ok: response.ok, body: parseJson(text) };
              });
            })
            .then(function (result) {
              credentialPromise = null;
              if (!result.ok || !Array.isArray(result.body)) {
                if (credentialStatus) {
                  credentialStatus.textContent = 'Unable to load credential inventory.';
                }
                return;
              }
              credentialCache = result.body;
              renderCredentialOptions();
            })
            .catch(function () {
              credentialPromise = null;
              if (credentialStatus) {
                credentialStatus.textContent = 'Unable to load credential inventory.';
              }
              credentialCache = [];
              renderCredentialOptions();
              updateSampleVisibility();
              resetSampleUI();
            });
        }

        function handleCredentialSelection() {
          if (!credentialSelect || currentMode() !== 'stored') {
            return;
          }
          if (!Array.isArray(credentialCache) || credentialCache.length === 0) {
            activeCredentialId = '';
            resetSampleUI();
            return;
          }
          var credentialId = credentialSelect.value ? credentialSelect.value.trim() : '';
          activeCredentialId = credentialId;
          resetSampleUI();
          if (!credentialId) {
            setSampleStatus('', null);
            return;
          }
          hideResultPanel(resultPanel);
          resetResultPanel(resultPanel);
          setAdvancedOpen(true);
          if (otpInput) {
            otpInput.value = '';
          }
          if (challengeInput) {
            challengeInput.removeAttribute('disabled');
            challengeInput.value = '';
          }
          if (sessionInput) {
            sessionInput.removeAttribute('disabled');
            sessionInput.value = '';
          }
          if (clientChallengeInput) {
            clientChallengeInput.removeAttribute('disabled');
            clientChallengeInput.value = '';
          }
          if (serverChallengeInput) {
            serverChallengeInput.removeAttribute('disabled');
            serverChallengeInput.value = '';
          }
          if (pinHashInput) {
            pinHashInput.removeAttribute('disabled');
            pinHashInput.value = '';
          }
          if (timestampInput) {
            timestampInput.removeAttribute('disabled');
            timestampInput.value = '';
          }
          if (counterInput) {
            counterInput.removeAttribute('disabled');
            counterInput.value = '';
          }
          setSampleStatus('Loading sample data…', null);
          ensureSample(credentialId)
            .then(function (sample) {
              if (credentialId !== activeCredentialId) {
                return;
              }
              if (sampleAvailable(sample)) {
                applySample(sample);
                var metadataEntry =
                  sample && sample.metadata && typeof sample.metadata === 'object'
                    ? sample.metadata
                    : {};
                var notes =
                  typeof metadataEntry.notes === 'string' ? metadataEntry.notes.trim() : '';
                var label =
                  typeof metadataEntry.samplePresetLabel === 'string'
                    ? metadataEntry.samplePresetLabel.trim()
                    : '';
                if (notes) {
                  setSampleStatus(notes, null);
                } else if (label) {
                  setSampleStatus('Sample "' + label + '" applied automatically.', null);
                } else {
                  setSampleStatus('Sample data applied automatically.', null);
                }
              } else {
                setSampleStatus('No curated sample data available for this credential.', 'warning');
              }
            })
            .catch(function () {
              if (credentialId === activeCredentialId) {
                setSampleStatus('Unable to load sample data.', 'error');
              }
            });
        }

        function renderCredentialOptions() {
          if (!credentialSelect) {
            return;
          }
          var options = Array.isArray(credentialCache) ? credentialCache : [];
          credentialSelect.innerHTML = '';
          var placeholder = doc.createElement('option');
          placeholder.value = '';
          placeholder.textContent = options.length ? 'Select a credential' : 'No credentials available';
          credentialSelect.appendChild(placeholder);
          options.forEach(function (entry) {
            if (!entry || typeof entry.id !== 'string') {
              return;
            }
            var option = doc.createElement('option');
            option.value = entry.id;
            option.textContent = entry.id + (entry.label ? ' — ' + entry.label : '');
            credentialSelect.appendChild(option);
          });
          credentialSelect.disabled = options.length === 0;
          if (credentialStatus) {
          credentialStatus.textContent = options.length
            ? ''
            : 'No stored credentials found. Import one before replaying.';
          }
          updateSampleVisibility();
          handleCredentialSelection();
        }

        function parseOcraSuite(suite) {
          if (!suite || typeof suite !== 'string') {
            return null;
          }
          var trimmed = suite.trim();
          if (!trimmed) {
            return null;
          }
          var parts = trimmed.split(':');
          if (parts.length !== 3) {
            return null;
          }
          var cryptoPart = parts[1];
          var dataPart = parts[2];
          var result = {
            suite: trimmed,
            counterRequired: false,
            pinRequired: false,
            challenge: null,
            sessionLengthBytes: 0,
            timestampStepSeconds: null,
            timestampRequired: false,
            requiresAdvanced: false,
            supportsSplitChallenge: false,
          };

          var cryptoStep = extractTimeStepSeconds(cryptoPart);
          if (cryptoStep) {
            result.timestampStepSeconds = cryptoStep;
          }

          var tokens = dataPart.split('-');
          tokens.forEach(function (token) {
            var trimmedToken = token.trim();
            if (!trimmedToken) {
              return;
            }
            var upper = trimmedToken.toUpperCase();
            if (upper === 'C') {
              result.counterRequired = true;
              return;
            }
            if (upper.startsWith('Q') && upper.length >= 3) {
              var formatChar = upper.charAt(1);
              var lengthPart = trimmedToken.substring(2).trim();
              var lengthValue = parseInt(lengthPart, 10);
              if (Number.isFinite(lengthValue) && lengthValue > 0) {
                result.challenge = { format: formatChar, length: lengthValue };
              }
              return;
            }
            if (upper.startsWith('P')) {
              result.pinRequired = true;
              return;
            }
            if (upper.startsWith('S')) {
              var sessionToken = trimmedToken.substring(1).trim();
              var sessionLength = parseSessionLength(sessionToken);
              if (Number.isFinite(sessionLength) && sessionLength > 0) {
                result.sessionLengthBytes = sessionLength;
              }
              return;
            }
            if (upper.startsWith('T')) {
              var stepSeconds = parseTimeStepToken(trimmedToken);
              if (Number.isFinite(stepSeconds) && stepSeconds > 0) {
                result.timestampStepSeconds = stepSeconds;
              }
            }
          });

          if (Number.isFinite(result.timestampStepSeconds) && result.timestampStepSeconds > 0) {
            result.timestampRequired = true;
          }
          if (!Number.isFinite(result.sessionLengthBytes) || result.sessionLengthBytes < 0) {
            result.sessionLengthBytes = 0;
          }
          result.requiresAdvanced =
            result.sessionLengthBytes > 0 || result.timestampRequired === true;
          return result;
        }

        function extractTimeStepSeconds(cryptoPart) {
          if (!cryptoPart || typeof cryptoPart !== 'string') {
            return null;
          }
          var cursor = cryptoPart.trim().toUpperCase();
          if (cursor.startsWith('HOTP')) {
            cursor = cursor.substring(4);
            if (cursor.startsWith('-')) {
              cursor = cursor.substring(1);
            }
          }
          if (!cursor.startsWith('T')) {
            return null;
          }
          var idx = 1;
          while (idx < cursor.length && /[0-9]/.test(cursor.charAt(idx))) {
            idx += 1;
          }
          if (idx === 1) {
            return null;
          }
          var numericPart = cursor.substring(1, idx);
          var seconds = parseInt(numericPart, 10);
          if (!Number.isFinite(seconds) || seconds <= 0) {
            return null;
          }
          var unitChar = cursor.charAt(idx);
          if (unitChar === 'M') {
            seconds *= 60;
          } else if (unitChar === 'H') {
            seconds *= 3600;
          }
          return seconds;
        }

        function parseSessionLength(token) {
          if (!token) {
            return 64;
          }
          var trimmed = token.trim();
          if (!trimmed) {
            return 64;
          }
          if (/^[0-9]+$/.test(trimmed)) {
            return parseInt(trimmed, 10);
          }
          var upper = trimmed.toUpperCase();
          if (upper === 'SHA1') {
            return 20;
          }
          if (upper === 'SHA256') {
            return 32;
          }
          if (upper === 'SHA512') {
            return 64;
          }
          return 64;
        }

        function parseTimeStepToken(token) {
          if (!token || typeof token !== 'string') {
            return null;
          }
          var upper = token.trim().toUpperCase();
          if (!upper.startsWith('T')) {
            return null;
          }
          var idx = 1;
          while (idx < upper.length && /[0-9]/.test(upper.charAt(idx))) {
            idx += 1;
          }
          if (idx === 1) {
            return null;
          }
          var numericPart = upper.substring(1, idx);
          var seconds = parseInt(numericPart, 10);
          if (!Number.isFinite(seconds) || seconds <= 0) {
            return null;
          }
          var unitChar = upper.charAt(idx);
          if (unitChar === 'M') {
            seconds *= 60;
          } else if (unitChar === 'H') {
            seconds *= 3600;
          }
          return seconds;
        }

        function findCredentialSummary(credentialId) {
          if (!Array.isArray(credentialCache)) {
            return null;
          }
          for (var index = 0; index < credentialCache.length; index += 1) {
            var entry = credentialCache[index];
            if (entry && typeof entry.id === 'string' && entry.id === credentialId) {
              return entry;
            }
          }
          return null;
        }

        function buildContext() {
          var context = {};
          if (challengeInput && challengeInput.value) {
            context.challenge = challengeInput.value.trim();
          }
          if (sessionInput && sessionInput.value) {
            context.sessionHex = sessionInput.value.trim();
          }
          if (clientChallengeInput && clientChallengeInput.value) {
            context.clientChallenge = clientChallengeInput.value.trim();
          }
          if (serverChallengeInput && serverChallengeInput.value) {
            context.serverChallenge = serverChallengeInput.value.trim();
          }
          if (pinHashInput && pinHashInput.value) {
            context.pinHashHex = pinHashInput.value.trim();
          }
          if (timestampInput && timestampInput.value) {
            context.timestampHex = timestampInput.value.trim();
          }
          if (counterInput && counterInput.value !== '') {
            var parsed = Number(counterInput.value);
            if (!Number.isNaN(parsed)) {
              context.counter = parsed;
            }
          }
          return context;
        }

        function buildPayload(mode) {
          var payload = { otp: otpInput ? otpInput.value.trim() : '' };
          var context = buildContext();
          payload.context = context;
          if (mode === 'stored') {
            var credentialId = credentialSelect ? credentialSelect.value.trim() : '';
            if (credentialId) {
              payload.credentialId = credentialId;
            }
          } else {
            var suite = suiteInput ? suiteInput.value.trim() : '';
            var secret = secretInput ? secretInput.value.trim() : '';
            if (suite || secret) {
              var inline = {};
              if (suite) {
                inline.suite = suite;
              }
              if (secret) {
                inline.sharedSecretHex = secret;
              }
              payload.inlineCredential = inline;
            }
          }
          return payload;
        }

        function applySample(sample) {
          if (!sampleAvailable(sample)) {
            return;
          }
          clearPanels();
          var context = sample.context || {};
          if (otpInput) {
            otpInput.value = fallback(sample.otp, '');
          }
          if (challengeInput) {
            challengeInput.value = fallback(context.challenge, '');
          }
          if (sessionInput) {
            sessionInput.value = fallback(context.sessionHex, '');
          }
          if (clientChallengeInput) {
            clientChallengeInput.value = fallback(context.clientChallenge, '');
          }
          if (serverChallengeInput) {
            serverChallengeInput.value = fallback(context.serverChallenge, '');
          }
          if (pinHashInput) {
            pinHashInput.value = fallback(context.pinHashHex, '');
          }
          if (timestampInput) {
            timestampInput.value = fallback(context.timestampHex, '');
          }
          if (counterInput) {
            counterInput.value =
              context.counter === null || context.counter === undefined
                ? ''
                : String(context.counter);
          }

          var hasAdvanced = Boolean(
            (context.sessionHex && context.sessionHex.trim && context.sessionHex.trim() !== '') ||
            (context.clientChallenge &&
              context.clientChallenge.trim &&
              context.clientChallenge.trim() !== '') ||
            (context.serverChallenge &&
              context.serverChallenge.trim &&
              context.serverChallenge.trim() !== '') ||
            (context.pinHashHex && context.pinHashHex.trim && context.pinHashHex.trim() !== '') ||
            (context.timestampHex && context.timestampHex.trim && context.timestampHex.trim() !== '') ||
            (context.counter !== null && context.counter !== undefined)
          );
          if (hasAdvanced) {
            setAdvancedOpen(true);
          }
        }

        function resetResultDisplay() {
          if (statusBadge) {
            statusBadge.textContent = '—';
            statusBadge.classList.remove('status-badge--success', 'status-badge--error', 'status-badge--info');
          }
          setTelemetryField(reasonCodeValue, '—');
          setTelemetryField(outcomeValue, '—');
          resetResultPanel(resultPanel);
        }

        function setTelemetryField(node, value) {
          if (!node) {
            return;
          }
          node.textContent = value || '—';
        }

        function applyStatusBadge(statusText) {
          if (!statusBadge) {
            return;
          }
          var normalized = typeof statusText === 'string' ? statusText.toLowerCase() : 'unknown';
          var display = normalized;
          if (normalized === 'match') {
            display = 'Match';
          } else if (normalized === 'mismatch' || normalized === 'strict_mismatch') {
            display = 'Mismatch';
          } else if (normalized === 'invalid') {
            display = 'Invalid';
          } else if (normalized === 'error') {
            display = 'Error';
          }
          statusBadge.textContent = display;
          statusBadge.classList.remove('status-badge--success', 'status-badge--error', 'status-badge--info');
          if (normalized === 'match') {
            statusBadge.classList.add('status-badge--success');
          } else if (normalized === 'mismatch' || normalized === 'strict_mismatch' || normalized === 'error') {
            statusBadge.classList.add('status-badge--error');
          } else {
            statusBadge.classList.add('status-badge--info');
          }
        }

        function applyPresetFields(presetKey) {
          if (!presetKey) {
            return;
          }
          var sample = presetMap[presetKey];
          if (!sample || typeof sample !== 'object') {
            return;
          }
          if (suiteInput) {
            suiteInput.value = fallback(sample.suite, '');
          }
          if (secretInput) {
            secretInput.value = fallback(sample.sharedSecretHex, '');
          }
          if (challengeInput) {
            challengeInput.value = fallback(sample.challenge, '');
          }
          if (sessionInput) {
            sessionInput.value = fallback(sample.sessionHex, '');
          }
          if (clientChallengeInput) {
            clientChallengeInput.value = fallback(sample.clientChallenge, '');
          }
          if (serverChallengeInput) {
            serverChallengeInput.value = fallback(sample.serverChallenge, '');
          }
          if (pinHashInput) {
            pinHashInput.value = fallback(sample.pinHashHex, '');
          }
          if (timestampInput) {
            timestampInput.value = fallback(sample.timestampHex, '');
          }
          if (counterInput) {
            var counterValue =
              sample.counter === null || sample.counter === undefined
                ? ''
                : sample.counter;
            counterInput.value = counterValue;
          }
          if (otpInput) {
            otpInput.value = fallback(sample.expectedOtp, '');
          }
        }

        function sanitizeContextFields() {
          if (pinHashInput) {
            pinHashInput.value = '';
          }
        }

        function renderSuccess(body, fallbackMode) {
          if (!body) {
            return null;
          }
          var statusText = (body.status || 'unknown').toString();
          var reasonCode = body.reasonCode || statusText;
          var metadata = body.metadata || {};
          var mode = fallback(metadata.mode || metadata.credentialSource, fallbackMode || 'stored');
          var outcome = fallback(metadata.outcome, reasonCode);
          var sanitized = normalizeBoolean(metadata.sanitized, 'true');
          var telemetryId = fallback(metadata.telemetryId, 'n/a');
          var credentialSource = fallback(metadata.credentialSource, mode);
          var fingerprint = fallback(metadata.contextFingerprint, 'unavailable');
          applyStatusBadge(statusText);
          setTelemetryField(reasonCodeValue, reasonCode);
          setTelemetryField(outcomeValue, outcome);
          resetResultPanel(resultPanel);
          showResultPanel(resultPanel);
          return {
            telemetryId: telemetryId,
            status: statusText,
            reasonCode: reasonCode,
            reason: null,
            mode: mode,
            credentialSource: credentialSource,
            outcome: outcome,
            contextFingerprint: fingerprint,
            sanitized: sanitized === 'true',
          };
        }

        function renderError(body, fallbackMode) {
          var field = '';
          var specificReason = '';
          var sanitized = 'true';
          var telemetryId = null;
          var mode = fallbackMode || 'stored';
          var statusValue = 'invalid';
          if (body && body.status) {
            statusValue = body.status;
          } else if (!body) {
            statusValue = 'error';
          }
          if (body && body.details) {
            var details = body.details;
            if (typeof details.reasonCode === 'string') {
              specificReason = details.reasonCode;
            }
            if (typeof details.field === 'string') {
              field = details.field;
            }
            if (details.sanitized !== undefined) {
              sanitized = normalizeBoolean(details.sanitized, sanitized);
            }
            if (typeof details.telemetryId === 'string') {
              telemetryId = details.telemetryId;
            }
            if (typeof details.mode === 'string') {
              mode = details.mode;
            }
          }
          var reason = body && body.message ? body.message : 'Unable to process replay request.';
          resetResultDisplay();
          applyStatusBadge(statusValue);
          var reasonLabel = specificReason || 'validation_failure';
          var suffix = field ? ' Field: ' + field + '.' : '';
          var hint =
              'Reason: ' + reasonLabel + '. Sanitized: ' + sanitized + '.' + suffix;
          showResultError(resultPanel, reason, hint);
          var reasonCodeValue = specificReason || (statusValue === 'error' ? 'unexpected_error' : 'validation_failure');
          return {
            telemetryId: telemetryId,
            status: statusValue,
            reasonCode: reasonCodeValue,
            reason: reason,
            mode: mode,
            credentialSource: body && body.metadata && body.metadata.credentialSource
              ? body.metadata.credentialSource
              : mode,
            outcome: specificReason || 'invalid',
            contextFingerprint: body && body.metadata && body.metadata.contextFingerprint
              ? body.metadata.contextFingerprint
              : 'unavailable',
            sanitized: sanitized === 'true',
          };
        }

        function emitTelemetry(summary) {
          if (!summary || !telemetryEndpoint) {
            return;
          }
          var telemetryId = summary.telemetryId;
          if (!telemetryId || telemetryId === 'n/a') {
            return;
          }
          var payload = {
            telemetryId: telemetryId,
            status: summary.status,
            reasonCode: summary.reasonCode,
            reason: summary.reason,
            mode: summary.mode,
            credentialSource: summary.credentialSource,
            outcome: summary.outcome,
            contextFingerprint: summary.contextFingerprint,
            sanitized: summary.sanitized,
          };
          var headers = {
            Accept: 'application/json',
            'Content-Type': 'application/json',
          };
          if (csrfToken) {
            headers['X-CSRF-TOKEN'] = csrfToken;
          }
          fetchDelegate(telemetryEndpoint, {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin',
            body: JSON.stringify(payload),
          }).catch(function () {
            // Telemetry is best effort; suppress failures.
          });
        }

        function handleSubmit(event) {
          event.preventDefault();
          clearPanels();
          setBusy(true);
          var selected = form.querySelector('input[name="replayMode"]:checked');
          var mode = selected ? selected.value : 'stored';
          var payload = buildPayload(mode);
          var headers = {
            Accept: 'application/json',
            'Content-Type': 'application/json',
          };
          if (csrfToken) {
            headers['X-CSRF-TOKEN'] = csrfToken;
          }

          try {
            window.__ocraReplayLastPayload = JSON.stringify(payload);
          } catch (err) {
            window.__ocraReplayLastPayload = null;
          }

          fetchDelegate(verificationEndpoint || '/api/v1/ocra/verify', {
            method: 'POST',
            headers: headers,
            credentials: 'same-origin',
            body: JSON.stringify(payload),
          })
            .then(function (response) {
              return response.text().then(function (text) {
                return { ok: response.ok, body: parseJson(text) };
              });
            })
            .then(function (result) {
              setBusy(false);
              sanitizeContextFields();
              try {
              window.__ocraReplayLastResponse = JSON.stringify({
                ok: !!result.ok,
                body: result.body || null,
                mode: mode,
              });
            } catch (err) {
              window.__ocraReplayLastResponse = null;
            }
            if (result.ok) {
              var summary = renderSuccess(result.body || {}, mode);
              emitTelemetry(summary);
              return;
            }
            var errorSummary = renderError(result.body || null, mode);
            emitTelemetry(errorSummary);
          })
          .catch(function () {
            setBusy(false);
            sanitizeContextFields();
            window.__ocraReplayLastResponse = JSON.stringify({
              ok: false,
              body: null,
              mode: mode,
              error: 'network',
            });
            var summary = renderError(null, mode);
            emitTelemetry(summary);
          });
        }

        function setAdvancedOpen(open) {
          if (!advancedToggle || !advancedPanel) {
            return;
          }
          var isExpanded = advancedToggle.getAttribute('aria-expanded') === 'true';
          if (open && !isExpanded) {
            advancedToggle.setAttribute('aria-expanded', 'true');
            advancedToggle.textContent = 'Hide advanced context';
            advancedPanel.setAttribute('data-open', 'true');
            show(advancedPanel);
          } else if (!open && isExpanded) {
            advancedToggle.setAttribute('aria-expanded', 'false');
            advancedToggle.textContent = 'Show advanced context';
            advancedPanel.setAttribute('data-open', 'false');
            hide(advancedPanel);
          }
        }

        function toggleAdvanced() {
          var isExpanded = advancedToggle.getAttribute('aria-expanded') === 'true';
          setAdvancedOpen(!isExpanded);
        }

        modeRadios.forEach(function (input) {
          input.addEventListener('change', function () {
            syncMode({ replace: true });
          });
        });
        form.addEventListener('submit', handleSubmit);
        advancedToggle.addEventListener('click', toggleAdvanced);
        if (credentialSelect) {
          credentialSelect.addEventListener('change', handleCredentialSelection);
        }
        if (presetSelect) {
          presetSelect.addEventListener('change', function (event) {
            var selectedKey = event && event.target ? event.target.value : '';
            if (!selectedKey) {
              return;
            }
            applyPresetFields(selectedKey);
          });
        }

        if (initialReplayMode) {
          var initialRadio =
            form && form.querySelector('input[name="replayMode"][value="' + initialReplayMode + '"]');
          if (initialRadio) {
            initialRadio.checked = true;
          }
          window.__ocraReplayInitialMode = undefined;
        }

        syncMode({ replace: true, force: true, skipFocus: true });
        fetchStoredCredentials();
        window.__ocraReplayReady = true;
      })();
    </script>
  </body>
</html>
