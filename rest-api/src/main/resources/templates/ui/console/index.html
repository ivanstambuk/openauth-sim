<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Operator Console</title>
    <link rel="stylesheet" th:href="@{/ui/ocra/console.css}" />
  </head>
  <body>
    <main class="operator-console" aria-labelledby="operator-console-heading">
      <header class="console-header">
        <div class="console-header__title">
          <h1 id="operator-console-heading">Operator Console</h1>
        </div>
        <div
            class="protocol-tabs"
            data-testid="operator-protocol-tabs"
            role="tablist"
            aria-label="Operator protocol selector"
          >
          <button
              class="protocol-tab protocol-tab--active"
              data-testid="protocol-tab-ocra"
              data-protocol-tab="ocra"
              role="tab"
              aria-selected="true"
              aria-controls="protocol-panel-ocra"
            >
            OCRA
          </button>
          <button
              class="protocol-tab"
              data-testid="protocol-tab-fido2"
              role="tab"
              data-protocol-tab="fido2"
              aria-selected="false"
              aria-controls="protocol-panel-fido2"
            >
            FIDO2 / WebAuthn
          </button>
          <button
              class="protocol-tab"
              data-testid="protocol-tab-emv"
              role="tab"
              data-protocol-tab="emv"
              aria-selected="false"
              aria-controls="protocol-panel-emv"
            >
            EMV / CAP
          </button>
        </div>
      </header>

      <section
          id="protocol-panel-ocra"
          class="protocol-panel"
          data-protocol-panel="ocra"
          aria-labelledby="protocol-tab-ocra"
        >
        <div
            class="ocra-mode-toggle"
            data-testid="ocra-mode-toggle"
            data-mode="evaluate"
            role="tablist"
            aria-label="OCRA interaction modes"
          >
          <button
              type="button"
              class="mode-pill mode-pill--active"
              data-testid="ocra-mode-select-evaluate"
              role="tab"
              aria-selected="true"
            >
            Evaluate
          </button>
          <button
              type="button"
              class="mode-pill"
              data-testid="ocra-mode-select-replay"
              role="tab"
              aria-selected="false"
            >
            Replay
          </button>
        </div>

        <th:block th:replace="~{ui/ocra/evaluate :: ocraEvaluatePanel(visible=${true})}"></th:block>
        <th:block th:replace="~{ui/ocra/evaluate :: ocraPolicyPresetData}"></th:block>

        <th:block th:replace="~{ui/ocra/replay :: ocraReplayPanel(visible=${false})}"></th:block>
        <th:block th:replace="~{ui/ocra/replay :: ocraReplayPresetData}"></th:block>
      </section>
      <section
          id="protocol-panel-fido2"
          class="protocol-panel protocol-panel--placeholder"
          data-protocol-panel="fido2"
          aria-labelledby="protocol-tab-fido2"
          hidden="hidden"
          aria-hidden="true"
        >
        <h2>FIDO2 / WebAuthn</h2>
        <p>
          Operator tooling for FIDO2/WebAuthn is in design. Tabs will activate once the protocol facade
          ships with REST + UI support.
        </p>
      </section>

      <section
          id="protocol-panel-emv"
          class="protocol-panel protocol-panel--placeholder"
          data-protocol-panel="emv"
          aria-labelledby="protocol-tab-emv"
          hidden="hidden"
          aria-hidden="true"
        >
        <h2>EMV / CAP</h2>
        <p>
          EMV/CAP operator workflows are planned. This panel will light up when credential flows and UI
          scaffolding are available.
        </p>
      </section>
    </main>
    <th:block th:replace="~{ui/ocra/evaluate :: ocraEvaluateScripts}"></th:block>
    <th:block th:replace="~{ui/ocra/replay :: ocraReplayScripts}"></th:block>

    <script th:inline="javascript">
      (function () {
        const protocolTabs = Array.from(
          document.querySelectorAll('[data-protocol-tab]')
        );
        const protocolPanels = Array.from(
          document.querySelectorAll('[data-protocol-panel]')
        );

        const modeToggle = document.querySelector("[data-testid='ocra-mode-toggle']");
        const evaluateButton =
          modeToggle && modeToggle.querySelector("[data-testid='ocra-mode-select-evaluate']");
        const replayButton =
          modeToggle && modeToggle.querySelector("[data-testid='ocra-mode-select-replay']");
        const evaluatePanel = document.querySelector("[data-testid='ocra-evaluate-panel']");
        const replayPanel = document.querySelector("[data-testid='ocra-replay-panel']");

        const allowedProtocols = new Set(['ocra', 'fido2', 'emv']);
        const allowedTabs = new Set(['evaluate', 'replay']);
        let currentProtocol = 'ocra';
        let lastOcraTab = 'evaluate';

        function setPanelVisibility(panel, hidden) {
          if (!panel) {
            return;
          }
          if (hidden) {
            panel.setAttribute('hidden', 'hidden');
            panel.setAttribute('aria-hidden', 'true');
          } else {
            panel.removeAttribute('hidden');
            panel.removeAttribute('aria-hidden');
          }
        }

        function toggleButtonState(button, active) {
          if (!button) {
            return;
          }
          button.classList.toggle('mode-pill--active', active);
          button.setAttribute('aria-selected', active ? 'true' : 'false');
        }

        function setActiveMode(mode) {
          if (!modeToggle) {
            return;
          }
          modeToggle.setAttribute('data-mode', mode);
          const isEvaluate = mode === 'evaluate';
          toggleButtonState(evaluateButton, isEvaluate);
          toggleButtonState(replayButton, !isEvaluate);
          setPanelVisibility(evaluatePanel, !isEvaluate);
          setPanelVisibility(replayPanel, isEvaluate);
          lastOcraTab = mode;
        }

        function setActiveProtocol(protocol, ocraMode) {
          protocolTabs.forEach((tab) => {
            const tabProtocol = tab.getAttribute('data-protocol-tab');
            const isActive = tabProtocol === protocol;
            tab.classList.toggle('protocol-tab--active', isActive);
            tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
          });

          protocolPanels.forEach((panel) => {
            const panelProtocol = panel.getAttribute('data-protocol-panel');
            const isActive = panelProtocol === protocol;
            setPanelVisibility(panel, !isActive);
          });

          if (protocol === 'ocra') {
            setPanelVisibility(modeToggle, false);
            setActiveMode(ocraMode || lastOcraTab || 'evaluate');
          } else {
            setPanelVisibility(modeToggle, true);
          }

          currentProtocol = protocol;
        }

        function normalizeState(state) {
          const protocol = allowedProtocols.has(state && state.protocol)
            ? state.protocol
            : 'ocra';
          if (protocol === 'ocra') {
            const tab = allowedTabs.has(state && state.tab) ? state.tab : 'evaluate';
            return { protocol, tab };
          }
          return { protocol };
        }

        function buildSearch(state) {
          const params = new URLSearchParams();
          params.set('protocol', state.protocol);
          if (state.protocol === 'ocra') {
            params.set('tab', state.tab);
          }
          const rendered = params.toString();
          return rendered ? `?${rendered}` : window.location.search;
        }

        function pushUrlState(state, options) {
          const search = buildSearch(state);
          const url = `${window.location.pathname}${search}`;
          const historyState = state.protocol === 'ocra'
            ? { protocol: state.protocol, tab: state.tab }
            : { protocol: state.protocol };

          if (options.replace) {
            window.history.replaceState(historyState, '', url);
            return;
          }

          if (window.location.search === search) {
            return;
          }

          window.history.pushState(historyState, '', url);
        }

        function applyConsoleState(nextState, options) {
          const normalized = normalizeState(nextState);
          const desiredProtocol = normalized.protocol;
          const desiredTab =
            desiredProtocol === 'ocra' ? normalized.tab : lastOcraTab;

          const isSameProtocol = desiredProtocol === currentProtocol;
          const isSameOcraTab =
            desiredProtocol !== 'ocra' || desiredTab === lastOcraTab;

          if (!isSameProtocol || !isSameOcraTab) {
            setActiveProtocol(desiredProtocol, desiredProtocol === 'ocra' ? normalized.tab : undefined);
          } else if (desiredProtocol === 'ocra') {
            setActiveMode(normalized.tab);
          }

          if (desiredProtocol === 'ocra') {
            lastOcraTab = normalized.tab;
          }

          if (options.updateUrl) {
            pushUrlState(normalized, options);
          }
        }

        function parseStateFromLocation() {
          const params = new URLSearchParams(window.location.search);
          const protocol = params.get('protocol');
          const tab = params.get('tab');
          return normalizeState({ protocol, tab });
        }

        protocolTabs.forEach((tab) => {
          tab.addEventListener('click', function (event) {
            event.preventDefault();
            const protocol = tab.getAttribute('data-protocol-tab');
            if (!protocol || !allowedProtocols.has(protocol)) {
              return;
            }
            const nextState =
              protocol === 'ocra'
                ? { protocol: 'ocra', tab: lastOcraTab }
                : { protocol };
            applyConsoleState(nextState, { updateUrl: true });
          });
        });

        if (evaluateButton) {
          evaluateButton.addEventListener('click', function (event) {
            event.preventDefault();
            applyConsoleState({ protocol: 'ocra', tab: 'evaluate' }, { updateUrl: true });
          });
        }

        if (replayButton) {
          replayButton.addEventListener('click', function (event) {
            event.preventDefault();
            applyConsoleState({ protocol: 'ocra', tab: 'replay' }, { updateUrl: true });
          });
        }

        window.addEventListener('popstate', function (event) {
          const state = event.state ? normalizeState(event.state) : parseStateFromLocation();
          applyConsoleState(state, { updateUrl: false });
        });

        applyConsoleState(parseStateFromLocation(), { updateUrl: true, replace: true });
      })();
    </script>
  </body>
</html>
