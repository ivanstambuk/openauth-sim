# Feature 039 Tasks – EMV/CAP Simulation Services

_Status: In progress_  
_Last updated: 2025-11-05 (T3930 stored secret sanitisation planning)_

- [x] T3901 – Fixture scaffolding & red tests: added `docs/test-vectors/emv-cap/{identify,respond,sign}-baseline.json`, captured session key/cryptogram/overlay/OTP metadata, and introduced `EmvCapSimulationVectorsTest` with deliberate failures pending domain wiring (Gradle run deferred until implementation). Commands: `./gradlew --no-daemon :core:test`.
- [x] T3902 – Core implementation: implemented session key derivation, CAP mode validation, Generate AC execution, and IPB masking to satisfy T3901 tests; introduced negative-path coverage for invalid hex and Identify-mode challenge misuse. Commands: `./gradlew --no-daemon :core:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3903 – Application orchestration & telemetry: added `EmvCapEvaluationApplicationService` with request/response records, sanitized telemetry adapters, mask-length analytics, and optional trace payload; introduced fixture-driven application tests covering all modes, validation failure handling, ATC substitution, and trace toggling. Commands: `./gradlew --no-daemon :application:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3904 – REST endpoint integration: exposed `POST /api/v1/emv/cap/evaluate`, introduced controller/service/DTOs with validation, covered Identify/Respond/Sign flows plus includeTrace toggle and missing-field errors via MockMvc, and refreshed OpenAPI snapshots. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.EmvCapEvaluationEndpointTest"`, `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :rest-api:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3905 – Documentation & telemetry verification: refreshed roadmap/knowledge map, added `docs/2-how-to/use-emv-cap-rest-operations.md`, updated `_current-session.md`, verified telemetry redaction via `./gradlew --no-daemon :application:test :rest-api:test`, and ran `./gradlew --no-daemon spotlessApply check`.
- [x] T3906 – CLI parity: delivered `emv cap evaluate` Picocli command with mode-aware validation, text + JSON outputs, includeTrace toggle, telemetry emission, and coverage for invalid/override flows (identify/respond/sign). Commands: `./gradlew --no-daemon :cli:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3907 – Persistence & seeding: wired `EmvCapCredentialPersistenceAdapter` + seeding application service, introduced shared `EmvCapSeedSamples`, exposed REST `POST /api/v1/emv/cap/credentials/seed`, added Picocli `emv cap seed`, and landed idempotency/telemetry coverage across application, REST, and CLI suites. Commands: `./gradlew --no-daemon :application:test --tests "io.openauth.sim.application.emv.cap.EmvCapSeedApplicationServiceTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.EmvCapCredentialSeedingEndpointTest"`, `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliTest"`.
- [x] T3908 – Operator UI integration: enabled the EMV/CAP console tab with stored credential presets, inline form, include-trace toggle, ResultCard wiring, and verbose trace panel plus new Selenium coverage. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :rest-api:test`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3908a – Operator UI layout alignment: refactored the EMV/CAP panel to the shared two-column layout, constrained the result pane to the OTP preview/status badge, and relocated mask length/masked digits/ATC/branch/height plus the ICC template into the verbose trace panel. Updated console JavaScript renders the preview row, writes metrics into the trace grid, and Selenium coverage now checks the relocated telemetry. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3908b – Verbose trace visibility parity: routed EMV/CAP responses through the shared `VerboseTraceConsole`, removed the bespoke panel, normalised trace payloads, and synced Selenium to assert copy-control reuse plus local include-trace gating against the global toggle. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :rest-api:test`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3908c – Fixture expansion: gathered **new, user-supplied** EMV/CAP vectors before the documentation sweep, including:
  * 2 `IDENTIFY` flows using branch factors `b ∈ {2,6}` and heights `H ∈ {6,10}`.
  * 2 `RESPOND` flows with numeric challenges of length 4 and 8 respectively (branch factor 4, height 8).
  * 2 `SIGN` flows with distinct reference+amount pairs (one amount <1000, one ≥5000) at branch factor 4, height 8.
  * 2 mismatch samples per mode capturing negative OTP comparisons for replay regression (Δ offsets ±1 and ±2).
  - Completed: wired the new fixtures into core/application/REST regression suites using parameterized coverage and reran `./gradlew --no-daemon :core:test :application:test :rest-api:test`.
- [x] T3909 – Documentation & full verification: published updated how-to guides (`docs/2-how-to/use-emv-cap-rest-operations.md`) and new CLI/UI companions, refreshed `docs/4-architecture/knowledge-map.md` with the extended fixture set, marked Feature 039 replay scope across roadmap/plan/spec, verified OpenAPI snapshots via `:rest-api:test`, and ran the full quality gate on 2025-11-02 (`./gradlew --no-daemon :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`).
- [x] T3910 – Replay scaffolding & red tests: extended the fixture catalogue with stored/inline replay vectors (`docs/test-vectors/emv-cap/replay-fixtures.json`), introduced failing coverage across application (`EmvCapReplayApplicationServiceTest`), REST (`EmvCapReplayEndpointTest`), CLI (`EmvCliReplayTest`), and UI (`EmvCapOperatorUiSeleniumTest`) suites, and documented pending implementation here prior to activation. Commands: `./gradlew --no-daemon :application:test :rest-api:test :cli:test :ui:test` (targeted classes), `./gradlew --no-daemon spotlessApply check` (expected red).
- [x] T3911 – Application replay orchestration & telemetry: implemented `EmvCapReplayApplicationService`, request/response records, telemetry adapters, and verbose trace assembly while driving T3910 tests to green; ensured mismatch signalling, preview-window overrides, and stored credential lookups align with evaluation semantics. Commands: `./gradlew --no-daemon :application:test --tests "io.openauth.sim.application.emv.cap.EmvCapReplayApplicationServiceTest"`, `./gradlew --no-daemon spotlessApply check` (remained red on facade work).
- [x] T3912 – REST replay endpoint & OpenAPI: introduced `POST /api/v1/emv/cap/replay`, DTOs, validation, telemetry wiring, MockMvc coverage for stored/inline success plus mismatch flows, and refreshed OpenAPI snapshots. Commands: `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.EmvCapReplayEndpointTest"`.
- [x] T3913 – CLI replay command: added `emv cap replay` Picocli command covering stored/inline flows, preview-window overrides, includeTrace toggle, JSON/text parity, and telemetry emission; CLI tests now assert match/mismatch outcomes and sanitized telemetry. Commands: `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliReplayTest"`, `./gradlew --no-daemon spotlessApply check` (still red pending UI replay).
- [x] T3914 – Operator UI replay integration: activated the Replay tab with stored preset dropdown, inline overrides, OTP entry, preview-window controls, include-trace checkbox, updated result card, and shared verbose trace console; refreshed console JavaScript to synchronise credential caches, share trace metadata, gate copy controls, and align Selenium coverage for stored match and inline mismatch flows. Commands: `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`; `./gradlew --no-daemon spotlessApply check` still fails at Jacoco branch coverage (0.68 < 0.70) after rerunning module test suites (`./gradlew --no-daemon --rerun-tasks :core:test :core-ocra:test :core-shared:test :application:test :infra-persistence:test :cli:test :rest-api:test :ui:test`).
- [x] T3915 – Replay documentation & final verification: updated REST/CLI/operator UI how-to guides with replay instructions, refreshed roadmap/knowledge map/session snapshot, and recorded telemetry behaviour. Added targeted EMV/TOTP replay tests to raise Jacoco branch coverage from 0.68 to 0.7000 and ran the full Gradle quality gate. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.*"`, `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliReplayTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.totp.TotpEvaluationServiceTest"`, `./gradlew --no-daemon :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`.
- [x] T3916 – Verbose trace key redaction: align EMV verbose traces with HOTP/TOTP/OCRA by hashing master keys (SHA-256) across application, REST, CLI, and operator UI layers while keeping session keys visible; update fixture expectations, Selenium/MockMvc assertions, and operator documentation to confirm digests replace raw master keys. Commands: `./gradlew --no-daemon :application:test --tests "io.openauth.sim.application.emv.cap.*"`, `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCli*"`, `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.*"`, `./gradlew --no-daemon :ui:test`. 
  - 2025-11-02: Application trace model now emits `masterKeySha256` digests (`sha256:<hex>`) alongside session keys; CLI/REST/UIs surface the digest in verbose traces and JSON payloads; OpenAPI snapshots refreshed.
  - 2025-11-02: EMV Selenium suite still red pending T3917 (global verbose toggle cleanup) because the protocol-specific include-trace checkboxes remain in the template; `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"` currently fails on the expected checkbox assertions and is deferred to the next task.
- [x] T3917 – Console verbose toggle harmonization: remove EMV-specific include-trace checkboxes, update UI templates/JS to defer to the global verbose toggle, refresh Selenium assertions, and clean up documentation/screenshots. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
  - 2025-11-02: EMV evaluate/replay templates and console JS now rely solely on the global verbose toggle; targeted Selenium run (`./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`) and `./gradlew --no-daemon :ui:test` both pass.
  - 2025-11-02: Initial full `./gradlew --no-daemon spotlessApply check` run failed at `:jacocoCoverageVerification` (branches 0.69 &lt; 0.70); remediation tracked before closing the task.
  - 2025-11-02: `jacocoAggregatedReport` confirmed project-wide branch coverage at 2160/3087 (≈0.6997). Covering any single additional branch (e.g., exercising the `includeTrace == null`/`false` code paths in `EmvCapEvaluationService` or `EmvCapReplayService`) would satisfy the ≥0.70 enforcement.
  - 2025-11-02: Added MockMvc tests for stored replay requests omitting `includeTrace` and explicitly setting it to `false`; `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.EmvCapReplayEndpointTest"` and the full `./gradlew --no-daemon spotlessApply check` now pass, and Jacoco reports 2161/3087 covered branches (≈0.7000).
- [x] T3918 – Operator UI stored evaluate parity: Evaluate tab now exposes a stored credential dropdown wired to the shared cache, enables preset submission with empty-state messaging, and keeps inline fields editable; Selenium coverage exercises stored submission, inline overrides, and global verbose toggle behaviour (`./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`).
- [x] T3919 – REST stored evaluate endpoint: `POST /api/v1/emv/cap/evaluate` accepts `credentialId`, resolves presets via `CredentialStore`, and records credential metadata in telemetry; MockMvc plus OpenAPI snapshot suites cover stored success, inline override precedence, validation errors, and includeTrace suppression (`./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.EmvCapEvaluationEndpointTest"`, `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`).
- [x] T3920 – CLI stored evaluate support: added `emv cap evaluate-stored` Picocli command leveraging the shared store, supporting inline overrides, JSON/text parity, sanitized telemetry, and includeTrace gating; new CLI tests cover stored success, override precedence, trace toggling, and digest redaction (`./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliEvaluateStoredTest"`, `./gradlew --no-daemon spotlessApply check`).
- [x] T3921 – Remove UI transaction override inputs: Evaluate/Replay panels drop resolved/override terminal payload controls, relying on verbose traces for resolved ICC data while REST/CLI retain advanced overrides; console JS and Selenium assertions updated accordingly and the full UI/REST suites remain green (`./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`).
- [x] T3922 – Evaluate mode toggle alignment: Reintroduced stored vs. inline evaluation selector on the EMV Evaluate tab, collapsed to a single Evaluate CTA bound to the active mode, updated console template/JavaScript wiring, and refreshed UI/Selenium/unit coverage. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.*"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3923 – Preview window controls alignment: Surfaced backward/forward preview offsets on the Evaluate tab, propagated the shared window schema through application/REST/CLI layers, and refreshed coverage. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.*"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCli*"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
  - 2025-11-04: Application service now builds `OtpPreview` lists for window offsets and records telemetry `previewWindowBackward/Forward`; tests assert delta ordering and central OTP preservation.
  - 2025-11-04: REST DTOs/response payloads expose `previewWindow` + `previews` arrays; OpenAPI snapshots regenerated and MockMvc suites updated to cover stored/inline preview adjustments.
  - 2025-11-04: CLI `emv cap evaluate`/`evaluate-stored` introduce `--window-backward/--window-forward`, print preview tables in text mode, and emit preview arrays in JSON responses; unit tests extended accordingly.
  - 2025-11-04: Operator UI adds preview offset inputs, preserves stored-mode submissions (without triggering inline fallback), renders multi-row preview tables, and Selenium coverage exercises non-zero offsets.
- [x] T3924 – Verbose diagnostic parity: Ensured EMV verbose traces expose ATC, branch factor, height, mask length, and preview window offsets across application/REST/CLI/UI traces; synced documentation/snapshots and reran the full Gradle quality gate. Commands: `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`.
- [x] T3925 – Replay selector ordering & helper copy: Reordered the replay mode toggle so inline parameters appear before stored credential, defaulted the toggle to inline, added concise helper copy (“Manual replay with full CAP derivation inputs.” / “Replay a seeded preset without advancing ATC.”), and refreshed Selenium coverage plus targeted UI/REST suites. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3925 – Evaluate selector placement parity: Moved the "Choose evaluation mode" fieldset directly beneath the Evaluate panel heading so the stored credential preset/inline parameter sections follow it, matching HOTP/TOTP/FIDO2 ordering; extended the Selenium suite with a document-order assertion to guarantee the selector precedes the preset controls. Commands: `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3926 – Sample vector terminology parity: Aligned the EMV Evaluate and Replay dropdown labels with other protocols by renaming them to "Load a sample vector" (with "Select a sample" placeholder) while keeping EMV hints concise; updated Selenium coverage and reran targeted REST/UI suites plus `./gradlew --no-daemon spotlessApply check`.
  - Application trace model now carries the additional metadata, REST/CLI serializers render the new fields, and operator console verbose traces surface the values via `VerboseTraceConsole`.
  - Tests covering EMV evaluation, CLI JSON/text output, REST endpoints, replay metadata, and JS/Selenium suites updated to assert the new diagnostics; OpenAPI snapshots refresh the schema additions.
- [x] T3927 – Sample vector spacing parity: Applied the shared `stack-offset-top-lg` utility to the Evaluate and Replay sample vector containers so EMV/CAP spacing matches other protocol panels, and added Selenium assertions to guard the helper on both panels; reran Selenium and the full formatting/check pipeline. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3928 – Evaluate sample block refinement: Moved seed actions inside the Evaluate preset field group, added inline spacing styles, extended Selenium assertions, and reran `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"` plus `./gradlew --no-daemon spotlessApply check`.
- [x] T3929 – Sample vector styling parity: Extended Selenium coverage so Evaluate and Replay sample vector selectors assert the shared inline preset container and dark surface dropdown, refactored `panel.html` markup accordingly, and reran `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`, and `./gradlew --no-daemon spotlessApply check`.
- [ ] T3930 – Stored credential secret sanitisation: Stage failing REST/JS/Selenium tests proving that credential directory responses and operator UI stored modes do not expose raw master key/CDOL1/IPB/ICC template/issuer application data, implement digest/length-only summaries with masked placeholders, ensure evaluation/replay submissions hydrate full credentials server-side, refresh OpenAPI snapshots if schemas shift, and rerun `./gradlew --no-daemon :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`.
