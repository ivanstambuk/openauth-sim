# Feature 039 Tasks – EMV/CAP Simulation Services

_Status: In progress_  
_Last updated: 2025-11-02_

- [x] T3901 – Fixture scaffolding & red tests: added `docs/test-vectors/emv-cap/{identify,respond,sign}-baseline.json`, captured session key/cryptogram/overlay/OTP metadata, and introduced `EmvCapSimulationVectorsTest` with deliberate failures pending domain wiring (Gradle run deferred until implementation). Commands: `./gradlew --no-daemon :core:test`.
- [x] T3902 – Core implementation: implemented session key derivation, CAP mode validation, Generate AC execution, and IPB masking to satisfy T3901 tests; introduced negative-path coverage for invalid hex and Identify-mode challenge misuse. Commands: `./gradlew --no-daemon :core:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3903 – Application orchestration & telemetry: added `EmvCapEvaluationApplicationService` with request/response records, sanitized telemetry adapters, mask-length analytics, and optional trace payload; introduced fixture-driven application tests covering all modes, validation failure handling, ATC substitution, and trace toggling. Commands: `./gradlew --no-daemon :application:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3904 – REST endpoint integration: exposed `POST /api/v1/emv/cap/evaluate`, introduced controller/service/DTOs with validation, covered Identify/Respond/Sign flows plus includeTrace toggle and missing-field errors via MockMvc, and refreshed OpenAPI snapshots. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.EmvCapEvaluationEndpointTest"`, `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :rest-api:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3905 – Documentation & telemetry verification: refreshed roadmap/knowledge map, added `docs/2-how-to/use-emv-cap-rest-operations.md`, updated `_current-session.md`, verified telemetry redaction via `./gradlew --no-daemon :application:test :rest-api:test`, and ran `./gradlew --no-daemon spotlessApply check`.
- [x] T3906 – CLI parity: delivered `emv cap evaluate` Picocli command with mode-aware validation, text + JSON outputs, includeTrace toggle, telemetry emission, and coverage for invalid/override flows (identify/respond/sign). Commands: `./gradlew --no-daemon :cli:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3907 – Persistence & seeding: wired `EmvCapCredentialPersistenceAdapter` + seeding application service, introduced shared `EmvCapSeedSamples`, exposed REST `POST /api/v1/emv/cap/credentials/seed`, added Picocli `emv cap seed`, and landed idempotency/telemetry coverage across application, REST, and CLI suites. Commands: `./gradlew --no-daemon :application:test --tests "io.openauth.sim.application.emv.cap.EmvCapSeedApplicationServiceTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.EmvCapCredentialSeedingEndpointTest"`, `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliTest"`.
- [x] T3908 – Operator UI integration: enabled the EMV/CAP console tab with stored credential presets, inline form, include-trace toggle, ResultCard wiring, and verbose trace panel plus new Selenium coverage. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :rest-api:test`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3908a – Operator UI layout alignment: refactored the EMV/CAP panel to the shared two-column layout, constrained the result pane to the OTP preview/status badge, and relocated mask length/masked digits/ATC/branch/height plus ICC template/resolved values into the verbose trace panel. Updated console JavaScript renders the preview row, writes metrics into the trace grid, and Selenium coverage now checks the relocated telemetry. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3908b – Verbose trace visibility parity: routed EMV/CAP responses through the shared `VerboseTraceConsole`, removed the bespoke panel, normalised trace payloads, and synced Selenium to assert copy-control reuse plus local include-trace gating against the global toggle. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`, `./gradlew --no-daemon :rest-api:test`, `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon spotlessApply check`.
- [x] T3908c – Fixture expansion: gathered **new, user-supplied** EMV/CAP vectors before the documentation sweep, including:
  * 2 `IDENTIFY` flows using branch factors `b ∈ {2,6}` and heights `H ∈ {6,10}`.
  * 2 `RESPOND` flows with numeric challenges of length 4 and 8 respectively (branch factor 4, height 8).
  * 2 `SIGN` flows with distinct reference+amount pairs (one amount <1000, one ≥5000) at branch factor 4, height 8.
  * 2 mismatch samples per mode capturing negative OTP comparisons for replay regression (Δ offsets ±1 and ±2).
  - Completed: wired the new fixtures into core/application/REST regression suites using parameterized coverage and reran `./gradlew --no-daemon :core:test :application:test :rest-api:test`.
- [x] T3909 – Documentation & full verification: published updated how-to guides (`docs/2-how-to/use-emv-cap-rest-operations.md`) and new CLI/UI companions, refreshed `docs/4-architecture/knowledge-map.md` with the extended fixture set, marked Feature 039 replay scope across roadmap/plan/spec, verified OpenAPI snapshots via `:rest-api:test`, and ran the full quality gate on 2025-11-02 (`./gradlew --no-daemon :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`).
- [x] T3910 – Replay scaffolding & red tests: extended the fixture catalogue with stored/inline replay vectors (`docs/test-vectors/emv-cap/replay-fixtures.json`), introduced failing coverage across application (`EmvCapReplayApplicationServiceTest`), REST (`EmvCapReplayEndpointTest`), CLI (`EmvCliReplayTest`), and UI (`EmvCapOperatorUiSeleniumTest`) suites, and documented pending implementation here prior to activation. Commands: `./gradlew --no-daemon :application:test :rest-api:test :cli:test :ui:test` (targeted classes), `./gradlew --no-daemon spotlessApply check` (expected red).
- [x] T3911 – Application replay orchestration & telemetry: implemented `EmvCapReplayApplicationService`, request/response records, telemetry adapters, and verbose trace assembly while driving T3910 tests to green; ensured mismatch signalling, preview-window overrides, and stored credential lookups align with evaluation semantics. Commands: `./gradlew --no-daemon :application:test --tests "io.openauth.sim.application.emv.cap.EmvCapReplayApplicationServiceTest"`, `./gradlew --no-daemon spotlessApply check` (remained red on facade work).
- [x] T3912 – REST replay endpoint & OpenAPI: introduced `POST /api/v1/emv/cap/replay`, DTOs, validation, telemetry wiring, MockMvc coverage for stored/inline success plus mismatch flows, and refreshed OpenAPI snapshots. Commands: `OPENAPI_SNAPSHOT_WRITE=true ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.EmvCapReplayEndpointTest"`.
- [x] T3913 – CLI replay command: added `emv cap replay` Picocli command covering stored/inline flows, preview-window overrides, includeTrace toggle, JSON/text parity, and telemetry emission; CLI tests now assert match/mismatch outcomes and sanitized telemetry. Commands: `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliReplayTest"`, `./gradlew --no-daemon spotlessApply check` (still red pending UI replay).
- [x] T3914 – Operator UI replay integration: activated the Replay tab with stored preset dropdown, inline overrides, OTP entry, preview-window controls, include-trace checkbox, updated result card, and shared verbose trace console; refreshed console JavaScript to synchronise credential caches, share trace metadata, gate copy controls, and align Selenium coverage for stored match and inline mismatch flows. Commands: `./gradlew --no-daemon :ui:test`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EmvCapOperatorUiSeleniumTest"`; `./gradlew --no-daemon spotlessApply check` still fails at Jacoco branch coverage (0.68 < 0.70) after rerunning module test suites (`./gradlew --no-daemon --rerun-tasks :core:test :core-ocra:test :core-shared:test :application:test :infra-persistence:test :cli:test :rest-api:test :ui:test`).
- [x] T3915 – Replay documentation & final verification: updated REST/CLI/operator UI how-to guides with replay instructions, refreshed roadmap/knowledge map/session snapshot, and recorded telemetry behaviour. Added targeted EMV/TOTP replay tests to raise Jacoco branch coverage from 0.68 to 0.7000 and ran the full Gradle quality gate. Commands: `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.emv.cap.*"`, `./gradlew --no-daemon :cli:test --tests "io.openauth.sim.cli.EmvCliReplayTest"`, `./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.totp.TotpEvaluationServiceTest"`, `./gradlew --no-daemon :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`.
