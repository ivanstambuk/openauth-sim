# Feature 006 Plan – EUDIW OpenID4VP Simulator

_Linked specification:_ [docs/4-architecture/features/006/spec.md](docs/4-architecture/features/006/spec.md)  
_Status:_ In progress  
_Last updated:_ 2025-11-13
## Vision & Success Criteria
- Demonstrate HAIP-aligned remote OpenID4VP exchanges end to end (request → wallet response → validation) without external wallets.
- Ship deterministic fixtures covering SD-JWT VC and ISO/IEC 18013-5 mdoc PID payloads, plus Trusted Authorities filtering.
- Provide REST, CLI, and operator UI surfaces with telemetry, traces, and documentation updates so operators can explore the simulator.
- Maintain Specification-Driven Development discipline: tests first, ≤30 minute increments, spotless/Gradle checks green after each step.

## Scope Alignment
- **In scope:** Verifier request builder, deterministic wallet responder, DCQL/Trusted Authorities evaluation, encryption path, fixture loaders, telemetry wiring, facade integrations (REST/CLI/UI).
- **Out of scope:** Same-device/DC-API flows, issuance (OpenID4VCI), persistent wallet state, dynamic trust federation resolution beyond the `aki`/`etsi_tl`/`openid_federation` filters delivered in this feature.

## Dependencies & Interfaces
- Extends `core` with DCQL, SD-JWT, and DeviceResponse helpers; requires optional JOSE/COSE libraries pending owner approval.
- Application services (`application.eudi.openid4vp`) orchestrate requests/responses and emit telemetry via `TelemetryContracts`.
- REST/CLI/UI facades consume the application service and share fixture loaders located under ``docs/test-vectors/eudiw/openid4vp`/`.
- Documentation touchpoints: roadmap, knowledge map, how-to guides, telemetry catalogue.

## Assumptions & Risks
- **Assumptions:**
  - Fixture catalog (synthetic PID SD-JWT + mdoc) remains available via `docs/test-vectors` and is kept in sync with spec DSL.
  - HAIP encryption libraries (Nimbus JOSE + COSE) are approved or stubs are provided before implementation.
  - Trusted Authority metadata (AKI snapshots) can be versioned locally without live network access.

- **Specification drift**: keep references current; re-run analysis gate after each major clarification.  
- **Crypto dependency footprint**: evaluate JOSE/COSE libraries; if owner approval denied, document reduced functionality and fallback strategy.  
- **Fixture authenticity**: clearly label synthetic vs conformance vectors; maintain provenance metadata to prevent confusion.  
- **Telemetry privacy**: review event payloads for PII; add regression tests ensuring redaction toggles work.

## Implementation Drift Gate

- **Status:** Pending – trigger the full gate once the Feature 006 tasks for Generate/Validate flows (including Trusted Authorities ingestion and UI wiring) are ✅ and the Gradle stack is green.

- **Drift Gate – Template for EUDIW OpenID4VP Simulator**

  - Summary: When ready to close Feature 006, run this gate to confirm that the spec, plan, tasks, code/tests, how-to guides, and telemetry/trace snapshots for the EUDIW OpenID4VP simulator (Generate/Validate flows) match, and that no undocumented behaviour or missing coverage remains.

  - **Preconditions**
    - [ ] ``docs/4-architecture/features/006`/{spec,plan,tasks}.md` updated to the current date with all decisions folded into normative sections (FR/NFR/behaviour/telemetry) and no legacy “Clarifications” sections.  
    - [ ] [docs/4-architecture/open-questions.md](docs/4-architecture/open-questions.md) has no `Open` entries for Feature 006.  
    - [ ] The following commands have been run in this increment and logged in [docs/_current-session.md](docs/_current-session.md):  
      - `./gradlew --no-daemon :core:test :application:test :cli:test :rest-api:test :ui:test pmdMain pmdTest spotlessApply check`  
      - `./gradlew --no-daemon jacocoTestReport` (temporary branch floor ≥0.60 until coverage improvements restore 0.70).  
      - `./gradlew --no-daemon spotbugsMain spotbugsTest` (at minimum for `core`, `application`, `rest-api`, `ui`).  
      - EUDIW console/REST harness commands referenced from the tasks checklist (Node/Selenium-based UI tests and telemetry snapshot generation).  

  - **Spec ↔ code/test mapping**
    - [ ] For each high-/medium-impact FR-006-XX and FR-040-XX requirement:  
      - Identify the implementing classes in `core` (e.g. DCQL evaluators, TrustedAuthorityFixtures, OpenID4VP helpers) and `application.eudi.openid4vp` (authorization request builder, wallet simulation, validation services).  
      - Identify tests that cover the success, validation, and failure branches (Generate/Validate, TA match/miss, invalid requests/presentations).  
    - [ ] Extend or refine the Scenario Tracking grid in this plan (or an appendix table) to include explicit code and test pointers for each FR/NFR/Scenario row.  

  - **Seam inventory & contract check (Generate/Validate, Native Java & facades)**
    - [ ] Confirm that application-level services (`OpenId4VpAuthorizationRequestService`, `OpenId4VpWalletSimulationService`, `OpenId4VpValidationService`, and any related helpers) implement the flows described in the spec (HAIP/Baseline toggles, QR URLs, `request_uri`, Trusted Authorities, DCQL preview).  
    - [ ] Verify that REST, CLI, and operator UI controllers use those services without bypassing their validation/telemetry behaviour.  
    - [ ] For the Native Java seams (`OpenId4VpWalletSimulationService`, `OpenId4VpValidationService`):  
      - Javadoc labels them as Native Java APIs, references Feature 006/014 FRs and ADR‑0007/0008, and points to [docs/2-how-to/use-eudiw-from-java.md](docs/2-how-to/use-eudiw-from-java.md).  
      - DTOs used in the Native Java API (e.g., `SimulateRequest`, `InlineSdJwt`, `ValidateRequest`, `InlineVpToken`, `StoredPresentation`) match the how-to guide examples.  

  - **How-to guides & telemetry/trace docs**
    - [ ] [docs/2-how-to/use-eudiw-from-java.md](docs/2-how-to/use-eudiw-from-java.md) and other EUDIW how-to guides (REST/CLI/UI) use the same types, method names, and semantics as the application services and fixtures.  
    - [ ] Telemetry documentation (e.g., [docs/3-reference/eudiw-openid4vp-telemetry-snapshot.md](docs/3-reference/eudiw-openid4vp-telemetry-snapshot.md) or equivalent) matches the actual `oid4vp.*` events emitted by the application (`TelemetryContracts` adapters for Generate/Validate).  
    - [ ] Operator UI docs describe the HAIP/Baseline toggles, DCQL preview panel, Trusted Authorities labels, and trace dock integration in a way that matches the UI JS tests and actual behaviour.  
    - [ ] Verify that the EUDIW OpenID4VP protocol reference page and diagrams ([docs/3-reference/protocols/eudiw-openid4vp.md](docs/3-reference/protocols/eudiw-openid4vp.md) and `docs/3-reference/protocols/diagrams/eudiw-openid4vp-*.puml`/`*.png`) accurately describe the current authorization request, wallet response, and validation flows, including Trusted Authorities behaviour and core/application entry points; update them in the same increment when behaviour changes.  

  - **Tests & quality coverage**
    - [ ] Generate/Validate behaviour is covered by tests across layers:  
      - `core` (DCQL evaluation, fixtures, TrustedAuthorities/DeviceResponse helpers).  
      - `application` (Generate/Validate services, TrustedAuthorityEvaluator, wallet simulation).  
      - `rest-api` (OpenID4VP endpoints, problem-details mapping).  
      - `ui` (EUDIW console JS tests for Evaluate/Replay, HAIP/Baseline toggles, Trusted Authorities labels).  
    - [ ] Native Java usage test (`OpenId4VpNativeJavaApiUsageTest`) covers at least:  
      - A successful Generate + Validate path using presets or inline SD‑JWT.  
      - A failure path (e.g., Trusted Authority miss or invalid request VP Token).  
    - [ ] `jacocoTestReport` shows acceptable coverage for the EUDIW packages; any shortfalls against FR‑006/FR‑040 scenarios are captured as follow-up tasks.  
    - [ ] `spotbugsMain spotbugsTest` reports are clean for EUDIW-related packages or known issues are converted into explicit tasks.  

  - **Telemetry, traces, and fixtures**
    - [ ] Telemetry events (`oid4vp.request.*`, `oid4vp.wallet.*`, `oid4vp.response.*`, `oid4vp.fixtures.ingested`) include only synthetic or redacted payloads as documented, with sensitive fields hashed or summarised.  
    - [ ] Verbose traces link back to operator UI result cards via consistent trace IDs and presentation identifiers.  
    - [ ] Fixture loaders (`TrustedAuthorityFixtures`, `SyntheticKeyFixtures`, stored presentations) remain in sync with ``docs/test-vectors/eudiw/openid4vp`/` metadata; any changes are reflected in both code and docs.  

  - **Drift capture & remediation**
    - [ ] Any high-/medium-impact drift (missing flows, misaligned telemetry, untested branches, discrepancies between docs and behaviour) is:  
      - Logged as an `Open` entry in [docs/4-architecture/open-questions.md](docs/4-architecture/open-questions.md) with links to spec/plan sections.  
      - Captured as explicit tasks in [docs/4-architecture/features/006/tasks.md](docs/4-architecture/features/006/tasks.md) (and, if cross-cutting, in the relevant cross-feature plans).  
    - [ ] Low-impact drift (typos, minor wording, small doc mismatches) is corrected directly in the spec/plan/tasks/docs, and the change is noted briefly in this section.  

  - **Gate output**
    - [ ] This section is updated with the gate run date, commands executed (with outcomes), and a short summary of “matches vs gaps” plus remediation notes.  
    - [ ] [docs/_current-session.md](docs/_current-session.md) logs the EUDIW Implementation Drift Gate run (date, commands, and reference to this plan section).  
    - [ ] Once no high- or medium-impact divergences remain and mandatory follow-ups are scheduled, Feature 006 can move toward completion status subject to owner sign-off.  

- **Verification log (partial runs to date)**  
  - 2025-11-15 – `./gradlew --no-daemon jacocoTestReport` (PASS – coverage aggregates refreshed for the EUDIW package, temporary 0.60 branch floor held while preparing the eventual drift gate evidence packet).  

## Increment Map
0. **I0 – Trusted list ingestion foundation (FR-040-18/25)**  
   - Add fixture metadata for ETSI Trust List entries and OpenID Federation identifiers; create loader utilities to parse local TL snapshots.  
   - Stage failing tests ensuring DCQL presets referencing `etsi_tl`/`openid_federation` resolve correctly.  
   - Commands: `./gradlew --no-daemon :core:test`.  

1. **I1 – Spec refinement & citation sync**  
   - Integrate GPT-5 Pro research (complete).  
   - Action: none (baseline done) – recorded for traceability.

2. **I2 – Fixture scaffolding & smoke tests (FR-040-18/19, NFR-040-01)** – _Completed 2025-11-06_  
   - Added synthetic PID fixtures (SD-JWT + mdoc) and deterministic seed files.  
   - Introduced `PidFixtureSmokeTest` alongside existing trusted authority coverage to assert fixture presence and PID namespace coverage.  
   - Command: `./gradlew --no-daemon :core:test`.

3. **I3 – Verifier request builder (FR-040-01/02/03/04/05/14)** – _Completed 2025-11-06_  
   - Added failing `OpenId4VpAuthorizationRequestServiceTest` cases covering DCQL enforcement, deterministic seed reuse, and telemetry expectations.  
   - 2025-11-06: Implemented the authorization request builder (HAIP enforcement guard, QR/URI renderers, nonce/state masking) and recorded `./gradlew --no-daemon :application:test` green alongside a documented `spotlessApply` run (blocked only by the pre-existing Feature 039 checkstyle path mismatch).  
   - Implement builder, JAR toggle, ASCII QR renderer, telemetry events `oid4vp.request.*`.  
   - Commands: `./gradlew --no-daemon :application:test`, `./gradlew --no-daemon spotlessApply check`.

4. **I4 – Wallet simulator foundations (FR-040-07/08/09/10/13)** – _Completed 2025-11-07_  
   - Stage tests verifying VP Token shape, SD-JWT disclosure hashing, KB-JWT generation.  
   - Implement SD-JWT wallet path with deterministic salts/keys (loading synthetic issuer/holder keys), stub DeviceResponse loader, and wire inline credential inputs (preset vs manual + sample selector) to the generator; expose stored-mode seeding utilities.  
   - 2025-11-06: SD-JWT wallet service implemented per Option A (recompute disclosure hashes); telemetry + trace hashes now return from `OpenId4VpWalletSimulationService`. `:application:test` passes; full `spotlessApply check` still fails on pre-existing Feature 039 checkstyle path lookup.  
   - 2025-11-07: Inline-only metadata, Trusted Authority mismatch handling, and telemetry propagation hardened via T4024/T4025 with `./gradlew --no-daemon :application:test --tests "io.openauth.sim.application.eudi.openid4vp.OpenId4VpWalletSimulationServiceTest"` and a 7m36s `spotlessApply check` run both green.  
   - Commands: `./gradlew --no-daemon :core:test :application:test`, `./gradlew --no-daemon spotlessApply check`.

5. **I5 – mdoc DeviceResponse path (FR-040-09/10/17)** – _Completed 2025-11-07_  
   - Add failing tests for DeviceResponse verification and Claims Path Pointer mapping.  
   - Implement DeviceResponse adapter (using fixture CBOR and synthetic issuer certs) and hydrate inline DeviceResponse uploads alongside presets and sample vector selection; include HAIP encryption toggle scaffolding and stored-mode seeding data.  
   - 2025-11-07: `MdocDeviceResponseFixtures.load` now hydrates fixture metadata + claims pointers, and `MdocWalletSimulationService` verifies DeviceResponse responses, Trusted Authority policies, and HAIP encryption hooks. Greens recorded via `./gradlew --no-daemon :core:test :application:test` followed by `./gradlew --no-daemon spotlessApply check`.
   - Commands: `./gradlew --no-daemon :core:test :application:test`.

6. **I6 – Trusted Authorities + error handling (FR-040-11/12/21)** – _Completed 2025-11-07_  
   - Stage tests for Authority Key Identifier (`aki`) matching positives/negatives and OID4VP error mapping.  
   - Implement Trusted Authority evaluator, integrate with validation pipeline, produce problem-details responses.  
   - 2025-11-07: `TrustedAuthorityEvaluator`, `Oid4vpProblemDetails`, and shared REST/CLI adapters landed, unblocking the new tests and wiring Trusted Authority decisions plus RFC 7807 `invalid_scope`/`invalid_request` payloads through authorization, wallet, and validation services.  
   - Commands: `./gradlew --no-daemon :application:test :core:test`, `./gradlew --no-daemon spotlessApply check`.

7. **I7 – Encryption enforcement (FR-040-04/20, NFR-040-03)** – _Completed 2025-11-07_  
   - Add failing tests for `direct_post.jwt` round-trip using fixture keys.  
   - Implement JWE encryption/decryption path (behind HAIP flag) and latency telemetry.  
   - 2025-11-07: `DirectPostJwtEncryptionService` now performs HAIP-compliant P-256 ECDH-ES + A128GCM, derives verifier coordinates from fixture scalars, captures latency metrics, and surfaces `invalid_request` problem-details on key/encryption failures with `:application:test` + `spotlessApply check` green.  
   - Commands: `./gradlew --no-daemon :application:test`, `./gradlew --no-daemon spotlessApply check`.

8. **I8 – Live Trusted Authority ingestion (FR-040-18/25, S-040-11)** – _Completed 2025-11-15_  
   - Snapshot EU LOTL sequence 373 plus Germany (149) and Slovenia (78) Trusted Lists under ``docs/trust/snapshots/2025-11-15`/` with SHA-256 manifests + metadata JSON so future refreshes remain reproducible.  
   - Updated trusted-authority snapshots, DCQL presets, stored presentations, and fixture provenance to expose new policies (`etsi_tl:lotl-373`, `etsi_tl:de-149`, `etsi_tl:si-78`) across REST/CLI/UI plus the ingestion metadata shown in operator docs.  
   - Wired `OpenId4VpFixtureIngestionService` through the REST `presentations/seed` endpoint so it emits real ingestion summaries, provenance fields (source URL, sequence, ingestId), and telemetry; refreshed the telemetry snapshot + how-to guides after rerunning the required Gradle/Node/Selenium suites.  
   - Commands:  
     - `curl --output build/tmp/lotl/eu-lotl.xml https://ec.europa.eu/tools/lotl/eu-lotl.xml` (signature verification via existing `DigestVerifier`).  
     - `./gradlew --no-daemon :core:test --tests "*FixtureDatasets*"`  
     - `./gradlew --no-daemon :application:test --tests "*OpenId4VpFixtureIngestionServiceTest*"`  
     - `./gradlew --no-daemon :rest-api:test --tests "*Oid4vpRestContractTest*"`  
     - `node --test [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js)`  
     - `OPENAUTH_SIM_PERSISTENCE_DATABASE_PATH=build/tmp/test-credentials.db ./gradlew --no-daemon :rest-api:test --tests "io.openauth.sim.rest.ui.EudiwOperatorUiSeleniumTest"`  
   - Deliverables: refreshed telemetry snapshot/how-to docs noting the provenance metadata, plus a runbook note describing how to repeat ingestion when new LOTL sequences publish.

### Drift Evidence – Functional Requirements
| ID | Implementation references | Tests / Evidence | Notes |
|----|---------------------------|------------------|-------|
| FR-006-01 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | Enforces vp_token + nonce/state fields and REST exposure. |
| FR-006-02 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java | Rejects missing or conflicting DCQL vs scope inputs. |
| FR-006-03 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | Covers QR payloads and request_uri hand-offs. |
| FR-006-04 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java | Fragment/direct_post/direct_post.jwt wiring plus encryption service. |
| FR-006-05 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java) | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | HAIP x509_hash clientId + signed-request toggle. |
| FR-006-06 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluator.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluatorTest.java | DCQL credential/claims/trust parsing and validation. |
| FR-006-07 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java)<br>core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java)<br>core/src/test/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasetsTest.java | Maps DCQL credential IDs to fixture-backed VP Tokens. |
| FR-006-08 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java) | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java | Ensures SD-JWT + optional KB-JWT fields surface + validate. |
| FR-006-09 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationService.java)<br>core/src/main/java/io/openauth/sim/core/eudi/openid4vp/MdocDeviceResponseFixtures.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationServiceTest.java)<br>core/src/test/java/io/openauth/sim/core/eudi/openid4vp/MdocDeviceResponseFixturesTest.java | Generates DeviceResponse containers with descriptor metadata. |
| FR-006-10 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java) | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java | Verifies disclosures, KB-JWT holder binding, COSE/MSO signatures. |
| FR-006-11 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluator.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluator.java)<br>core/src/main/java/io/openauth/sim/core/eudi/openid4vp/TrustedAuthorityFixtures.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluatorTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluatorTest.java)<br>core/src/test/java/io/openauth/sim/core/eudi/openid4vp/TrustedAuthorityFixturesTest.java | Authority Key Identifier filtering + snapshots. |
| FR-006-12 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpProblemDetailsMapper.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpProblemDetailsMapper.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdvice.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpProblemDetailsMapperTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpProblemDetailsMapperTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdviceTest.java<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | Problem-details responses for invalid_request/scope/presentation/wallet. |
| FR-006-13 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java | Seeded determinism for request IDs, nonce/state, and VP Tokens. |
| FR-006-14 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpVerboseTraceBuilder.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpVerboseTraceBuilder.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java | Telemetry `oid4vp.*` events capture sanitized fields + durations. |
| FR-006-15 | [rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java](rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpApplicationConfiguration.java | [rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java](rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/OpenApiSnapshotTest.java | REST endpoints (request, wallet, validate, seed) + OpenAPI snapshots. |
| FR-006-16 | [cli/src/main/java/io/openauth/sim/cli/eudi/openid4vp/EudiwCli.java](cli/src/main/java/io/openauth/sim/cli/eudi/openid4vp/EudiwCli.java)<br>cli/src/main/java/io/openauth/sim/cli/eudi/openid4vp/EudiwCliServices.java | [cli/src/test/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpCliContractTest.java](cli/src/test/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpCliContractTest.java) | Picocli commands for request creation, QR render, wallet simulate, validate. |
| FR-006-17 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js<br>rest-api/src/main/java/io/openauth/sim/rest/ui/EudiwOperatorConsoleData.java | [rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java](rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java)<br>rest-api/src/test/javascript/eudi/openid4vp/console.test.js | Operator console tab layout, ASCII QR preview, telemetry copy. |
| FR-006-18 | [core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java](core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java<br>docs/trust/snapshots/2025-11-15/ | [core/src/test/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasetsTest.java](core/src/test/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasetsTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java | Synthetic + conformance fixture ingestion with provenance metadata. |
| FR-006-19 | [core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java](core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java)<br>docs/test-vectors/eudiw/openid4vp/fixtures/ | [core/src/test/java/io/openauth/sim/core/eudi/openid4vp/PidFixtureSmokeTest.java](core/src/test/java/io/openauth/sim/core/eudi/openid4vp/PidFixtureSmokeTest.java)<br>core/src/test/java/io/openauth/sim/core/eudi/openid4vp/MdocDeviceResponseFixturesTest.java | PID fixtures exist for SD-JWT + mdoc payloads. |
| FR-006-20 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java) | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java | direct_post.jwt path uses ECDH-ES+A128GCM and telemetry latency. |
| FR-006-21 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdvice.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdviceTest.java | HAIP encryption failures raise invalid_request problem details. |
| FR-006-22 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>rest-api/src/test/javascript/eudi/openid4vp/console.test.js | Baseline toggle relaxes signing/encryption and shows banner copy. |
| FR-006-23 | [rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java](rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java)<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html<br>cli/src/main/java/io/openauth/sim/cli/eudi/openid4vp/EudiwCli.java | [rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java](rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java<br>cli/src/test/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpCliContractTest.java | Generate vs Validate (Evaluate/Replay) flows across facades. |
| FR-006-24 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js | [rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java](rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java)<br>rest-api/src/test/javascript/eudi/openid4vp/console.test.js | Multi-presentation collapsibles + trace IDs per descriptor. |
| FR-006-25 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Preset vs inline SD-JWT/mdoc inputs before simulation. |
| FR-006-26 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>rest-api/src/main/java/io/openauth/sim/rest/ui/EudiwOperatorConsoleData.java | [rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java](rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java) | Read-only DCQL preview for each preset. |
| FR-006-27 | [rest-api/src/main/java/io/openauth/sim/rest/ui/EudiwOperatorConsoleData.java](rest-api/src/main/java/io/openauth/sim/rest/ui/EudiwOperatorConsoleData.java)<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js) | Friendly Trusted Authority labels + metadata display. |
| FR-006-28 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js | [rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java](rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java) | Inline VP Token JSON render + copy/download controls. |
| FR-006-29 | [core/src/main/java/io/openauth/sim/core/eudi/openid4vp/SyntheticKeyFixtures.java](core/src/main/java/io/openauth/sim/core/eudi/openid4vp/SyntheticKeyFixtures.java)<br>docs/test-vectors/eudiw/openid4vp/fixtures/ | [core/src/test/java/io/openauth/sim/core/eudi/openid4vp/SyntheticKeyFixturesTest.java](core/src/test/java/io/openauth/sim/core/eudi/openid4vp/SyntheticKeyFixturesTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java | Synthetic issuer/holder keys + trust anchors for deterministic runs. |
| FR-006-30 | [rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js](rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js) | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js) | Load sample vector pre-populates inline credential inputs. |
| FR-006-31 | [rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js](rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js) | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Deep-link and history hydration for protocol/tab/mode state. |
| FR-006-32 | [rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java](rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java)<br>cli/src/main/java/io/openauth/sim/cli/eudi/openid4vp/EudiwCli.java | [rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java](rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java)<br>cli/src/test/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpCliContractTest.java | Shared verbose flag surfaces `VerboseTracePayload` on REST/CLI. |
| FR-006-33 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java<br>rest-api/src/test/javascript/eudi/openid4vp/console.test.js | Stored presentation seeding endpoint + UI affordance. |

### Drift Evidence – Non-Functional Requirements
| ID | Implementation references | Tests / Evidence | Notes |
|----|---------------------------|------------------|-------|
| NFR-006-01 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java<br>core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java<br>core/src/test/java/io/openauth/sim/core/eudi/openid4vp/PidFixtureSmokeTest.java | Seeded deterministic behaviour (request IDs, VP Tokens, fixtures) proven by repeated test runs. |
| NFR-006-02 | [core-architecture-tests/src/test/java/io/openauth/sim/architecture/ReflectionPolicyTest.java](core-architecture-tests/src/test/java/io/openauth/sim/architecture/ReflectionPolicyTest.java)<br>core-architecture-tests/src/test/java/io/openauth/sim/architecture/ReflectionRegexScanTest.java | [core-architecture-tests/src/test/java/io/openauth/sim/architecture/ReflectionPolicyTest.java](core-architecture-tests/src/test/java/io/openauth/sim/architecture/ReflectionPolicyTest.java)<br>core-architecture-tests/src/test/java/io/openauth/sim/architecture/ReflectionRegexScanTest.java | Architecture tests + regex scan enforce the no-reflection policy for production/tests. |
| NFR-006-03 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpVerboseTraceBuilder.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java | Telemetry publishers capture `durationMs`/latency for encryption + wallet/validate paths, ensuring perf budgets stay observable. |
| NFR-006-04 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpVerboseTraceBuilder.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpVerboseTraceBuilder.java)<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Trace builder hashes payloads + UI only renders sanitised summaries (masked nonce, hashed VP Token). |
| NFR-006-05 | [docs/4-architecture/features/006/tasks.md](docs/4-architecture/features/006/tasks.md)<br>docs/_current-session.md | [docs/_current-session.md](docs/_current-session.md) | T-006-22 tracks roadmap/knowledge-map/doc refresh + `_current-session.md` logs the latest `./gradlew --no-daemon spotlessApply check` sweep on 2025-11-15. |

## Scenario Tracking
| Scenario ID | Increment reference | Implementation references | Tests / Evidence | Notes |
|-------------|--------------------|---------------------------|------------------|-------|
| S-006-01 | I3 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | HAIP authorization request (signed/encrypted, deterministic QR + telemetry). |
| S-006-02 | I3 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdvice.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | Invalid DCQL/scope combinations surface `invalid_request` problem details. |
| S-006-03 | I4 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationService.java<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationServiceTest.java<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Wallet simulate (inline + preset) emits deterministic SD-JWT/mdoc VP Tokens. |
| S-006-04 | I5 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationService.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpProblemDetailsMapper.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java<br>cli/src/test/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpCliContractTest.java | Validation failures propagate error codes/violations to REST + CLI. |
| S-006-05 | I7 | [rest-api/src/main/resources/static/ui/shared/verbose-trace.js](rest-api/src/main/resources/static/ui/shared/verbose-trace.js)<br>rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/Oid4vpVerboseTraceBuilder.java | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Global include-trace toggle disables dock + telemetry records includeTrace=false. |
| S-006-06 | I7 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestService.java | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpAuthorizationRequestServiceTest.java | Baseline profile banner + optional encryption/signing path. |
| S-006-07 | I7 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java)<br>rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Stored Evaluate/Replay journeys hydrate presets and mask secrets. |
| S-006-08 | I7 | [rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js](rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js) | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js) | Inline sample loader pre-populates SD-JWT/mdoc inputs. |
| S-006-09 | I0 / I10 | [core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java](core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java<br>docs/trust/snapshots/2025-11-15/ | [core/src/test/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasetsTest.java](core/src/test/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasetsTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java | Synthetic vs conformance fixture toggles with provenance telemetry. |
| S-006-10 | I0 / I6 | [rest-api/src/main/java/io/openauth/sim/rest/ui/EudiwOperatorConsoleData.java](rest-api/src/main/java/io/openauth/sim/rest/ui/EudiwOperatorConsoleData.java)<br>application/src/main/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluator.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluatorTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/TrustedAuthorityEvaluatorTest.java)<br>rest-api/src/test/javascript/eudi/openid4vp/console.test.js | Trusted Authority labels + AKI policies flow through traces without secrets. |
| S-006-11 | I7 | [rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html](rest-api/src/main/resources/templates/ui/eudi/openid4vp/panel.html)<br>rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpWalletSimulationServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Multi-presentation results + trace IDs per descriptor. |
| S-006-12 | T-006-19 | [rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js](rest-api/src/main/resources/static/ui/eudi-openid4vp/console.js) | [rest-api/src/test/javascript/eudi/openid4vp/console.test.js](rest-api/src/test/javascript/eudi/openid4vp/console.test.js)<br>rest-api/src/test/java/io/openauth/sim/rest/ui/EudiwOperatorUiSeleniumTest.java | Deep-link query params (protocol/tab/mode) survive reload/back-forward. |
| S-006-13 | I4 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationService.java) | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/MdocWalletSimulationServiceTest.java)<br>application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpValidationServiceTest.java | DeviceResponse simulations remain deterministic and trigger HAIP encryption when needed. |
| S-006-14 | I6 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionService.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdvice.java | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/DirectPostJwtEncryptionServiceTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdviceTest.java | HAIP encryption failures emit actionable `invalid_request` payloads. |
| S-006-15 | I5 / I6 | [rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java](rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpController.java)<br>rest-api/src/main/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdvice.java<br>cli/src/main/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpProblemDetailsFormatter.java | [rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java](rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java)<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpProblemDetailsAdviceTest.java<br>cli/src/test/java/io/openauth/sim/cli/eudi/openid4vp/Oid4vpCliContractTest.java | Problem-details formatting stays aligned across REST + CLI. |
| S-006-16 | T-006-23 | [application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java](application/src/main/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionService.java)<br>core/src/main/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasets.java<br>docs/trust/snapshots/2025-11-15/ | [application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java](application/src/test/java/io/openauth/sim/application/eudi/openid4vp/OpenId4VpFixtureIngestionServiceTest.java)<br>core/src/test/java/io/openauth/sim/core/eudi/openid4vp/FixtureDatasetsTest.java<br>rest-api/src/test/java/io/openauth/sim/rest/eudi/openid4vp/Oid4vpRestContractTest.java | Live Trusted Authority ingestion (EU LOTL + DE/SI snapshots) drives `/presentations/seed` output + telemetry. |

## Analysis Gate
- **Completed:** 2025-11-06 – Specification, plan, and tasks alignment checkpoint before implementation resumed.  
- ✅ Specification completeness – Overview, goals, requirements FR-040-01…FR-040-33 documented; clarifications up to 2025-11-01 captured; Operator UI ASCII mock-ups included.  
- ✅ Open questions review – [docs/4-architecture/open-questions.md](docs/4-architecture/open-questions.md) has no entries for Feature 040.  
- ✅ Plan alignment – Plan links to the Feature 040 spec/tasks and mirrors scope/dependencies noted in the specification.  
- ✅ Tasks coverage – T-040-01–T-040-22 map to the functional requirements (IDs referenced per task), stage tests before implementation, and keep increments ≤30 minutes.  
- ✅ Constitution compliance – Workflow preserves spec-first, clarification gate, test-first cadence, and straight-line increments via dedicated helpers.  
- ✅ Tooling readiness – Commands (`./gradlew --no-daemon :core:test`, `spotlessApply check`, `spotbugsMain spotbugsTest`, etc.) documented; telemetry snapshot notes retained.  
- Outcome: proceed to implementation once initial failing tests are staged (starting with T-040-01/T-040-02).

## Exit Criteria
- REST/CLI/UI demonstrate remote OpenID4VP exchange for SD-JWT VC and mdoc fixtures under deterministic seeds.
- Encryption path validated and telemetered; Trusted Authorities filtering operational with documented follow-ups for future enhancements.
- Synthetic vs conformance fixture toggles functional with provenance tracking.
- Roadmap, knowledge map, and supporting docs updated; all tests (`spotlessApply check`, module suites) passing.

## Follow-ups / Backlog
- T-040-24 – Same-device/DC-API exploration once prioritised.
- T-040-25 – OpenID4VCI issuance simulator alignment for end-to-end wallet journeys.
- T-040-26 – Trusted Authorities expansion (live TL updates, OpenID Federation resolution).
- T-040-27 – Reinstate JaCoCo branch threshold ≥0.70 after coverage stabilises.
- Quality guardrail – After any plan/task/spec change, run `./gradlew --no-daemon spotbugsMain spotbugsTest` plus `./gradlew --no-daemon spotlessApply check`; document deviations before proceeding.
- Telemetry snapshot note – Capture payload diffs via existing snapshot tests each increment so sanitisation regressions surface before implementation resumes.
- Native Java API alignment – Completed 2025-11-15 via T-006-28/29: EUDIW OpenID4VP Native Java seams now use `OpenId4VpWalletSimulationService` and `OpenId4VpValidationService` as façade entry points, with usage captured in [docs/2-how-to/use-eudiw-from-java.md](docs/2-how-to/use-eudiw-from-java.md) and `OpenId4VpNativeJavaApiUsageTest`; future Javadoc/CI wiring remains under Feature 014.
