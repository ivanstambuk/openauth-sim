# Feature Plan 022 – HOTP Operator Support

_Status: Draft_
_Last updated: 2025-10-06_

## Objective
Implement end-to-end HOTP flows (core domain, shared persistence, telemetry, CLI, REST) so operators can manage HOTP credentials alongside OCRA while reusing the existing schema-v1 storage baseline.

Reference specification: `docs/4-architecture/specs/feature-022-hotp-operator-support.md`.

## Success Criteria
- HOTP credential descriptors and generators comply with RFC 4226 (`HOS-001`).
- HOTP records coexist with OCRA entries in the shared MapDB store without migrations (`HOS-002`).
- CLI commands import/list/evaluate HOTP credentials with telemetry parity (`HOS-003`).
- REST endpoints expose HOTP evaluation (stored + inline) with OpenAPI updates and telemetry (`HOS-004`).
- Documentation (how-to, roadmap, knowledge map) surfaces HOTP usage and schema reuse (`HOS-005`).
- `./gradlew spotlessApply check` remains green after each increment.

## Proposed Increments
- ☑ R2201 – Draft HOTP generator/validator tests (expected failure) covering counter rollovers and digit variants.
- ☑ R2202 – Implement HOTP domain components and make tests pass; extend mutation/ArchUnit coverage.
- ☑ R2203 – Wire HOTP persistence via shared MapDB store; add integration tests mixing OCRA + HOTP records.
- ☑ R2204 – Add application-layer services + telemetry adapters for HOTP evaluation/issuance scenarios.
- ☑ R2205 – Implement CLI commands and tests for HOTP import/list/evaluate with telemetry assertions.
- ☑ R2206 – Introduce REST evaluation endpoint (stored + inline), update OpenAPI snapshots, and add MockMvc coverage.
- ☑ R2207 – Refresh documentation (how-to, roadmap highlights, knowledge map) and rerun full quality gate.
- ☑ R2208 – Add failing operator console tests covering HOTP stored credential evaluation (integration/system) and update UI plan artifacts.
- ☑ R2209 – Implement HOTP stored credential evaluation in the operator console (reuse REST API, ensure telemetry parity) and make R2208 pass.
- ☑ R2210 – Add failing operator console tests for HOTP inline evaluation (manual secret entry) and accessibility coverage.
- ☑ R2211 – Implement HOTP inline evaluation in the operator console, reuse REST telemetry, and satisfy R2210.
- ☑ R2212 – Update operator how-to docs, roadmap, knowledge map, and rerun `./gradlew spotlessApply check` after HOTP UI additions.
- ☑ R2213 – Add failing REST MockMvc + telemetry tests for HOTP replay (stored + inline) covering non-mutating counter behaviour and dedicated `hotp.replay` adapter wiring.
- ☑ R2214 – Implement HOTP replay service/controller pair with dedicated `POST /api/v1/hotp/replay` endpoint, ensure counters stay unchanged, refresh OpenAPI snapshots, and satisfy R2213.
- ☑ R2215 – Add failing Selenium tests for HOTP replay UI (stored + inline) including sample data and advanced context toggles mirroring OCRA, asserting telemetry identifiers surface.
- ☑ R2216 – Implement HOTP replay UI wiring (Thymeleaf templates + static JS), integrate with REST replay endpoint, and make R2215 pass.
- ☑ R2217 – Sync documentation/knowledge map/roadmap with HOTP replay, capture telemetry guidance, and rerun `./gradlew spotlessApply check`.
- ☑ R2218 – Add failing operator console integration coverage asserting HOTP evaluate/replay actions update the browser URL with `protocol=hotp` and the active tab before refresh. (2025-10-05: `./gradlew :rest-api:test --tests "…hotpTabsPersistQueryParameters"` failed as expected.)
- ☑ R2219 – Implement HOTP console deep-link handling so evaluate/replay tabs push the appropriate query parameters and make R2218 pass. (2025-10-05: tests green after JS updates; full `./gradlew spotlessApply check` executed; `hotpReplayDeepLinkSurvivesRefresh` Selenium coverage added.)
- ☑ R2220 – Update HOTP operator console Selenium coverage to require inline/stored evaluation panels render without headings or hint copy once a mode is active (expected failure; `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.OperatorConsoleUnificationSeleniumTest"` red with legacy headings still present).
- ☑ R2221 – Remove HOTP evaluation headings/hints from the UI template/JS, adjust accessibility attributes, and make R2220 pass via targeted UI tests (`OperatorConsoleUnificationSeleniumTest`, `HotpOperatorUiSeleniumTest`) followed by full `./gradlew spotlessApply check` (green 2025-10-05).
- ☑ R2226 – Update REST and UI test suites to fail when inline HOTP evaluation sends an identifier field; refresh OpenAPI expectations for the trimmed request contract. (2025-10-05: controller/service/UI tests adjusted; OpenAPI snapshots updated to drop `identifier`.)
- ☑ R2227 – Remove the identifier requirement from HOTP inline evaluation (REST/application/core), adjust UI payloads, regenerate OpenAPI snapshots, and rerun `./gradlew spotlessApply check`. (2025-10-05: identifier field removed end-to-end; tests/JS/docs updated; coverage restored after new replay utility tests; `spotlessApply` attempted but blocked by google-java-format runtime, see build log.)
- ☑ R2228 – Align google-java-format usage by forcing version 1.28.0 across Spotless and annotation processor configurations, refresh dependency locks, and confirm `./gradlew spotlessApply check` succeeds without runtime mismatches. (2025-10-05: added a global resolutionStrategy force in `build.gradle.kts`, regenerated module lockfiles via targeted `--write-locks` compile runs, and verified `./gradlew spotlessApply check`.)
- ☑ R2229 – Add `com.github.spotbugs:spotbugs-annotations` as a REST API test-only dependency to resolve HtmlUnit `@SuppressFBWarnings` compilation warnings; regenerate dependency locks if tooling demands it. (2025-10-05: added testImplementation dependency with `because` note, refreshed `rest-api/gradle.lockfile` via `compileTestJava`, `test`, and `pmdTest` `--write-locks`, confirmed `:rest-api:compileTestJava` now runs without warnings.)
- ☑ R2230 – Add `serialVersionUID` fields to HOTP/OCRA exception classes in application and REST modules, then rerun `./gradlew spotlessApply check` to confirm compiler warnings are cleared. (2025-10-05: populated `serialVersionUID` in all flagged exception types; full `spotlessApply check` still red because `core-architecture-tests:ReflectionRegexScanTest` detects legacy reflection helpers in HOTP CLI/REST tests—no new reflection introduced here; `:rest-api:compileTestJava` and `:application:compileJava` both clean.)
- ☑ R2231 – Remove reflection helpers from HOTP CLI/REST tests by exposing package-level seams and rerun `core-architecture-tests:ReflectionRegexScanTest` to prove the guardrail is green. (2025-10-05: widened `HotpCli.databasePath()`/`HotpReplayService.hasText|safeMessage` visibility, updated tests to call them directly, executed `:cli:test --tests HotpCliTest`, `:rest-api:test --tests HotpReplayServiceTest`, and `:core-architecture-tests:test --tests ReflectionRegexScanTest`; followed with full `./gradlew spotlessApply check`.)
- ☑ R2232 – Add failing REST and UI tests expecting HOTP Evaluate panels to omit OTP inputs, surface generated OTP values (stored + inline), and expose multiple inline presets (SHA-1 + SHA-256). (2025-10-05: introduced `HotpEvaluationEndpointTest.inlineHotpEvaluationPresetMetadata` + `HotpOperatorUiSeleniumTest.inlineHotpEvaluationSucceeds` assertions; confirmed red with targeted `:application:test`, `:rest-api:test` runs before implementation.)
- ☑ R2233 – Update HOTP evaluation services, REST contracts, and UI templates/JS to generate and display OTPs without operator input while wiring multiple inline presets (SHA-1 + SHA-256); refresh documentation and rerun `./gradlew spotlessApply check`. (2025-10-05: extended application telemetry/result metadata with preset keys, REST metadata serialization, and operator console JS/Thymeleaf preset controls; validated with `./gradlew :application:test --tests "…evaluateInlinePresetMetadataPropagatesToTelemetry"`, `./gradlew :rest-api:test --tests "…inlineHotpEvaluationPresetMetadata"`, `./gradlew :rest-api:test --tests "…HotpOperatorUiSeleniumTest.inlineHotpEvaluationSucceeds"`.)
- ☑ R2234 – Add failing Selenium/UI regression ensuring HOTP Evaluate selects Inline parameters by default after initial load and browser refresh, mirroring the OCRA benchmark. (2025-10-06: updated `HotpOperatorUiSeleniumTest` + `OperatorConsoleUnificationSeleniumTest` to assert inline defaults and refresh persistence; confirmed failure via `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest.hotpEvaluateDefaultsToInlineModeAfterRefresh"` before implementation.)
- ☑ R2235 – Implement HOTP Evaluate default-mode update so the UI, JS state, and controller responses select Inline parameters on first render/refresh; refresh affected docs/tests and rerun `./gradlew spotlessApply check`. (2025-10-06: adjusted HOTP panel markup + console.js defaults to inline, reran targeted Selenium suites and full `./gradlew spotlessApply check`.)

Each increment must complete within ≤10 minutes, lead with tests where practicable, and record tooling outcomes below.

## Checklist Before Implementation
- [x] Specification created with clarifications recorded.
- [x] Open questions resolved and captured in spec (pending session sign-off).
- [x] Tasks drafted with test-first ordering.
- [x] Analysis gate rerun once plan/tasks align.

## Tooling Readiness
- HOTP tests will extend existing JUnit/PIT suites under `core`/`application` modules.
- CLI/REST automation uses existing Picocli and MockMvc harnesses introduced for OCRA.
- Telemetry assertions rely on `TelemetryContracts` fixtures; ensure new event keys are covered.

## Notes
- Capture intent logs and command sequences for each increment in this plan.
- HOTP UI work is now in scope for evaluation flows (stored + inline) within the existing operator console; issuance remains out of scope per 2025-10-05 directive and is tracked on the roadmap.
- Operator UI remains evaluation-only; issuance flows stay deferred per 2025-10-05 directive and are tracked on the roadmap for future consideration.
- HOTP replay work introduces dedicated `hotp.replay` telemetry streams for REST and UI surfaces while keeping evaluation events untouched; documentation must call out both namespaces.
- 2025-10-04 – R2201 added HOTP generator/validator tests (failing) covering RFC 4226 vectors, 8-digit support, secret bounds, validation success/failure, and counter overflow guard; `./gradlew :core:test --tests io.openauth.sim.core.otp.hotp.*` fails as expected with `UnsupportedOperationException` placeholders.
- 2025-10-04 – R2202 implemented HOTP generator/validator, enforcing secret length, digit bounds, counter overflow guard, and RFC 4226 dynamic truncation; `./gradlew :core:test --tests io.openauth.sim.core.otp.hotp.*` passes and full `./gradlew --no-configuration-cache spotlessApply check` validates the suite (mutation tests included).
- 2025-10-04 – R2203 added integration coverage exercising `CredentialStoreFactory` with mixed OCRA/HOTP records; initial run (`./gradlew :infra-persistence:test --tests io.openauth.sim.infra.persistence.CredentialStoreFactoryHotpIntegrationTest`) failed while HOTP type/metadata were absent, then T2204 normalised persisted attributes (defaulting `hotp.counter`) so the test and full `./gradlew --no-configuration-cache spotlessApply check` now pass.
- 2025-10-04 – Application layer confirmed to own HOTP counter advancement and telemetry shaping (Option A); CLI/REST increments will call shared services rather than duplicating logic.
- 2025-10-05 – R2204 added HOTP evaluation + issuance application services, telemetry adapters, and contract coverage. `./gradlew :application:test --tests io.openauth.sim.application.hotp.*` failed before implementation, then passed after wiring services. Final validation via `./gradlew --no-configuration-cache spotlessApply check` succeeded.
- 2025-10-05 – R2205 delivered HOTP CLI import/list/evaluate flows backed by the new application services; coverage now exercises success, validation, and error telemetry (`./gradlew :cli:test --tests io.openauth.sim.cli.HotpCliTest`) and aggregate quality gates remain ≥0.90 after `./gradlew --no-configuration-cache spotlessApply check`.
- 2025-10-05 – R2206 introduced REST-facing MockMvc + endpoint tests (stored + inline) and OpenAPI expectations for HOTP evaluation. After wiring the controller/service, `./gradlew :rest-api:test --tests "io.openauth.sim.rest.hotp.HotpEvaluationControllerTest"` and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.HotpEvaluationEndpointTest"` pass, and OpenAPI snapshots were refreshed via `OPENAPI_SNAPSHOT_WRITE=true ./gradlew :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"`.
- 2025-10-05 – R2207 synced docs (spec, roadmap, knowledge map) with the HOTP REST slice and tightened HOTP REST coverage. `./gradlew --no-configuration-cache spotlessApply check` now succeeds with Jacoco branch coverage ≈0.9002 and line coverage ≈0.9706.
- 2025-10-05 – R2208 drafted failing Selenium coverage for HOTP stored evaluation in the operator console (`./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest.storedCredentialEvaluationSucceeds"` currently fails with a TimeoutException because the HOTP panel is a placeholder).
- 2025-10-05 – R2210 drafted failing Selenium coverage for HOTP inline evaluation with accessibility assertions; targeted run (`./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest.inlineHotpEvaluationSucceeds"`) is expected to fail until the UI wiring lands.
- 2025-10-05 – R2209 implemented HOTP stored evaluation UI, wired credential directory fetches, and refreshed Selenium coverage; targeted suite now passes (`./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest"`).
- 2025-10-05 – R2211 wired inline HOTP evaluation UI (identifier/secret/algorithm/digits/counter inputs) and shared result rendering, keeping telemetry metadata intact; Selenium suite above exercises both flows and confirms accessibility attributes.
- 2025-10-05 – Added HOTP credential directory endpoint + unit tests to supply the UI with stored credential metadata (`./gradlew :rest-api:test --tests "io.openauth.sim.rest.hotp.HotpCredentialDirectoryControllerTest"`).
- 2025-10-05 – R2212 refreshed operator documentation (new HOTP UI how-to, roadmap/knowledge-map updates) and re-ran the quality gate (`./gradlew spotlessApply check`), restoring aggregated branch coverage ≥0.90 after adding validation edge-case tests.
- 2025-10-05 – Replay scope confirmed: dedicated `POST /api/v1/hotp/replay` endpoint (stored + inline, read-only counters), operator UI mirroring OCRA replay, and dedicated `hotp.replay` telemetry stream.
- 2025-10-05 – R2213 drafted failing REST MockMvc coverage for HOTP replay (stored + inline) with telemetry assertions plus an OpenAPI contract check; `./gradlew :rest-api:test --tests "io.openauth.sim.rest.HotpReplayEndpointTest"` fails (404) and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest.openApiDocumentsHotpReplayEndpoint"` fails (path absent) pending replay implementation.
- 2025-10-05 – R2214 implemented HOTP replay application + REST layers, refreshed OpenAPI snapshots, and satisfied the new tests; `./gradlew :application:test --tests "io.openauth.sim.application.hotp.HotpReplayApplicationServiceTest"`, `./gradlew :rest-api:test --tests "io.openauth.sim.rest.HotpReplayEndpointTest"`, and full `./gradlew :rest-api:test` now pass after `OPENAPI_SNAPSHOT_WRITE=true ./gradlew :rest-api:test --tests "io.openauth.sim.rest.OpenApiSnapshotTest"` updated snapshots.
- 2025-10-05 – R2215 authored failing Selenium coverage for HOTP replay stored/inline flows (sample loader, advanced toggle, telemetry surfacing). Targeted run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiReplaySeleniumTest"` currently fails with TimeoutException because the replay tab lacks UI wiring (expected until R2216 lands).
- 2025-10-05 – R2216 wired HOTP replay Thymeleaf/JS, enabling stored + inline sample presets, advanced context toggle, and telemetry normalization to `ui-hotp-*`. Targeted suite `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiReplaySeleniumTest"` now passes, and replay metadata surfaces `credentialSource`, `previousCounter`, `nextCounter`, and UI-prefixed telemetry identifiers.
- 2025-10-05 – R2217 refreshed HOTP operator docs/roadmap/knowledge map with replay coverage and telemetry guidance, added focused REST tests for `HotpReplayService`/`HotpReplayController` plus a Selenium helper tweak to await enabled selects, and re-ran `./gradlew :rest-api:test --tests "io.openauth.sim.rest.hotp.HotpReplayServiceTest" --tests "io.openauth.sim.rest.hotp.HotpReplayControllerTest"` followed by `./gradlew :rest-api:test`. Final verification via `./gradlew --no-configuration-cache spotlessApply check` restored branch coverage ≥0.90.
- 2025-10-05 – R2228 completed by forcing google-java-format 1.28.0 across Spotless and annotation processor classpaths (global `resolutionStrategy.force`), regenerating dependency locks with targeted `--write-locks` compile runs, and rerunning `./gradlew spotlessApply check` to confirm the formatter mismatch is resolved.
- 2025-10-05 – R2234 complete: Selenium assertions expect HOTP inline result card to mirror OCRA layout (heading, OTP/status labels, metadata removal, right-side placement); targeted run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest.inlineHotpEvaluationSucceeds"` fails with NoSuchElement (legacy heading), confirming pre-change state.
- 2025-10-05 – R2235 complete: updated HOTP inline templates/JS to mirror the OCRA evaluation card (right-column layout, heading/labels, success badge) while stripping inline metadata; `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest"` and full `./gradlew spotlessApply check` now pass.
- 2025-10-06 – R2236 complete: Selenium assertions now require a single section-columns container with the HOTP status column’s first visible child matching the active result panel; targeted run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest.inlineHotpEvaluationSucceeds"` failed pre-change, establishing the guard.
- 2025-10-06 – R2237 complete: HOTP evaluate template consolidated to a single section-columns layout with the shared status column on the top-right; JS badge rendering reused without modification. `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest"` and full `./gradlew spotlessApply check` both pass.
- 2025-10-06 – R2238 complete: Selenium assertions now require HOTP OTP/Status rows to mirror the OCRA evaluation panel (inline labels/values); targeted run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeleniumTest"` first failed, then passed post-R2239.
- 2025-10-06 – R2239 complete: HOTP result panel markup adopts the OCRA card structure (inline OTP paragraph, status `<dl>`), status badge rendering preserved, and metadata rows removed; targeted UI suite plus full `./gradlew spotlessApply check` both green.
- 2025-10-06 – R2240 complete: Selenium assertions now require the OCRA evaluation result to surface the shared success badge (`status-badge--success`); targeted run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.OcraOperatorUiSeleniumTest"` failed prior to markup updates.
- 2025-10-06 – R2241 complete: OCRA result panel markup/scripts adopt the HOTP badge styling and mixed inline row, shrinking the card to match HOTP dimensions; targeted OCRA/HOTP suites and full `./gradlew spotlessApply check` pass.
- ☐ R2242 – Add failing REST + Selenium coverage for the HOTP stored credential seeding button (empty-store scenario, telemetry assertions, idempotency) via targeted `:rest-api:test` runs.
- ☑ R2243 – Implement HOTP seeding service and REST endpoint mirroring the OCRA flow, append canonical SHA-1/6 and SHA-256/8 credentials without overwriting existing entries, and satisfy R2242. (2025-10-06: hotp seed service + controller endpoint added; `./gradlew :application:test --tests "io.openauth.sim.application.telemetry.HotpTelemetryContractTest"` and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.HotpCredentialSeedingEndpointTest"` now pass.)
- ☑ R2244 – Wire the operator UI seeding button to the HOTP endpoint (stored-mode only), surface status messaging, reuse preset metadata, and rerun targeted UI suites. (2025-10-06: added stored-mode seed controls to the HOTP panel, parsed canonical seed metadata from `HotpOperatorSampleData` for replay hints, and refreshed `console.js` to call `/api/v1/hotp/credentials/seed`; targeted run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeedingSeleniumTest"` now passes.)
- ☑ R2245 – Sync documentation (how-to, roadmap, knowledge map) and rerun `./gradlew spotlessApply check` after HOTP seeding lands. (2025-10-06: refreshed HOTP operator UI how-to with the stored-mode seeding workflow, updated the roadmap and knowledge map entries, and prepared to rerun the formatting/verification task.)
- 2025-10-06 – R2242 targeted `./gradlew :rest-api:test --tests "io.openauth.sim.rest.HotpCredentialSeedingEndpointTest"` and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeedingSeleniumTest"`; REST seeding now passes post-R2243 while the Selenium scenario remains red pending UI wiring.
- ☑ R2246 – Add failing Selenium assertions that the HOTP stored evaluation “Seed sample credentials” button renders above the stored credential selector (matching OCRA), using `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeedingSeleniumTest"` as the targeted gate. (2025-10-06: assertion now enforces document order; targeted test run failed pre-change as expected.)
- ☑ R2247 – Update the HOTP operator evaluate template/JS to reposition the seeding button ahead of the selector, keep spacing/copy unchanged, and rerun the targeted UI suite plus `./gradlew spotlessApply check` to satisfy R2246. (2025-10-06: reordered Thymeleaf markup, added wait for placeholder text, reran targeted Selenium suite with `--rerun-tasks`, and full `./gradlew spotlessApply check` passed.)
- ☑ R2248 – Add failing Selenium assertions that enforce a minimum vertical gap between the HOTP mode selector and the seeding control to mirror the OCRA layout (`./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.HotpOperatorUiSeedingSeleniumTest"`). (2025-10-06: assertion now inspects computed margin-top; initial run red with 0 px margin.)
- ☑ R2249 – Adjust HOTP/OCRA shared styling so the seeding control inherits the required spacing, confirm the new Selenium expectation, and rerun `./gradlew spotlessApply check`. (2025-10-06: added inline spacing on HOTP seed actions, tweaked Selenium helpers to avoid stale elements, targeted test + full spotless/check pipeline now green.)

## Analysis Gate (2025-10-04)
- [x] Specification completeness – HOS requirements and clarifications recorded (telemetry parity, shared schema, CLI/REST scope).
- [x] Open questions review – No open entries for Feature 022 in `open-questions.md`.
- [x] Plan alignment – Feature plan references spec/tasks and mirrors success criteria.
- [x] Tasks coverage – T2201–T2221 cover test-first increments for each requirement.
- [x] Constitution compliance – Work honours spec-first, test-first, dependency guardrails.
- [x] Tooling readiness – Plan documents `./gradlew spotlessApply check`, reuses SpotBugs/quality gate context.
