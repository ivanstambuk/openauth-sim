# Feature Plan 023 – TOTP Operator Support

_Status: Complete_
_Last updated: 2025-10-11_

## Objective
Deliver RFC 6238-compliant TOTP evaluation and replay flows across core, shared persistence, application services, CLI, REST, and operator console UI so operators can validate time-based OTPs alongside HOTP and OCRA.

Reference specification: `docs/4-architecture/specs/feature-023-totp-operator-support.md`.

## Success Criteria
- TOS-001 – Core TOTP generators/validators cover SHA-1/SHA-256/SHA-512, 6/8 digits, and configurable step durations with comprehensive tests.
- TOS-002 – MapDB schema v1 stores TOTP descriptors without migrations and coexists with HOTP/OCRA records.
- TOS-003 & TOS-004 – Application services evaluate stored/inline submissions with drift controls, emit `totp.evaluate`/`totp.replay` telemetry, and redact secrets.
- TOS-005 – CLI imports/lists/evaluates TOTP credentials with drift/timestamp controls and telemetry parity.
- TOS-006 – REST endpoints (`/api/v1/totp/evaluate`, `/inline`, `/replay`) satisfy MockMvc + OpenAPI coverage and keep replay non-mutating.
- TOS-007 – Operator console surfaces TOTP evaluate/replay panels with presets, drift/timestamp overrides, and query-parameter deep links.
- TOS-008 – Documentation (operator how-to, roadmap, knowledge map) reflects live TOTP capabilities.
- TOS-NFR-001..004 – Coverage, SpotBugs, accessibility, and telemetry sanitisation guardrails remain green via `./gradlew qualityGate` and `./gradlew spotlessApply check`.
- 2025-10-12 – Inline preset catalogue expanded with RFC 6238 SHA-256 and SHA-512 8-digit samples (labelled with the RFC suffix) plus plain-labelled 6-digit truncations for UI parity across algorithms.
- 2025-10-13 – TOTP evaluation result cards drop telemetry and drift metadata in favour of the HOTP/OCRA presentation (evaluation heading + OTP + status badge).
- 2025-10-13 – Stored credential seeding now provisions the same SHA-1/SHA-256/SHA-512 presets (6/8-digit, 30s step) exposed in the inline dropdown so operators see identical labels across modes.

## Proposed Increments
- ☑ R2301 – Add failing core unit tests for TOTP generator/validator covering algorithm/digit permutations, time-step conversion, and drift window boundaries. (_2025-10-08 – Introduced RFC 6238 vectors and drift scenarios; `./gradlew :core:test` failed on missing TOTP domain classes._)
- ☑ R2302 – Implement core TOTP domain logic to satisfy R2301; extend ArchUnit/mutation coverage if required. (_2025-10-08 – Added descriptors, hash enum, generator, validator, drift window, and verification result types; `./gradlew :core:test` now green._)
- ☑ R2303 – Add failing persistence integration tests exercising mixed HOTP/OCRA/TOTP records via `CredentialStoreFactory`. (_2025-10-08 – `CredentialStoreFactoryTotpIntegrationTest` asserts TOTP coexistence; `./gradlew :infra-persistence:test --tests \"...TotpIntegrationTest\"` initially red on missing `OATH_TOTP` support._)
- ☑ R2304 – Implement persistence descriptor updates and schema adjustments to make R2303 pass without migrations. (_2025-10-08 – Added `OATH_TOTP` credential type plus TOTP persistence defaults in `MapDbCredentialStore`; targeted test now green via `./gradlew :infra-persistence:test --tests \"...TotpIntegrationTest\"`._)
- ☑ R2305 – Add failing application-layer tests for stored/inline evaluation with drift/timestamp overrides plus telemetry assertions. (_2025-10-08 – `TotpEvaluationApplicationServiceTest` added; `./gradlew :application:test --tests \"...TotpEvaluationApplicationServiceTest\"` initially red pending service/telemetry implementation._)
- ☑ R2306 – Implement application services and telemetry adapters to satisfy R2305; ensure secrets remain redacted. (_2025-10-08 – Introduced `TotpEvaluationApplicationService` + telemetry adapter, updated TelemetryContracts; targeted test now green via `./gradlew :application:test --tests \"...TotpEvaluationApplicationServiceTest\"`._)
- ☑ R2307 – Add failing CLI command tests (import/list/evaluate/replay) covering drift controls, error handling, and telemetry. (_2025-10-08 – `TotpCliTest` staged harness + assertions; `./gradlew :cli:test --tests "io.openauth.sim.cli.TotpCliTest"` initially red via placeholder harness._)
- ☑ R2308 – Implement CLI commands/wiring to satisfy R2307; rerun targeted CLI test suites. (_2025-10-08 – Implemented `TotpCli` list/evaluate/evaluate-inline commands; `./gradlew :cli:test --tests "io.openauth.sim.cli.TotpCliTest"` now passes._)
- ☑ R2309 – Add failing REST MockMvc/OpenAPI tests for evaluation and replay endpoints, including timestamp override and non-mutating replay cases. (_2025-10-08 – `TotpEvaluationEndpointTest` added with `fail(...)`; `./gradlew :rest-api:test --tests "io.openauth.sim.rest.TotpEvaluationEndpointTest"` initially red pending implementation._)
- ☑ R2310 – Implement REST controllers/services to satisfy R2309; regenerate OpenAPI snapshots and run `./gradlew :rest-api:test`. (_2025-10-08 – Added TOTP REST configuration/service/controller and regenerated OpenAPI snapshots via `OPENAPI_SNAPSHOT_WRITE=true ./gradlew :rest-api:test`._)
- ☑ R2311 – Add failing Selenium/UI integration tests for operator console TOTP evaluate/replay panels (presets, drift/timestamp inputs, query-parameter persistence). (_2025-10-08 – Introduced `TotpOperatorUiSeleniumTest` asserting stored success, inline validation errors, and query-parameter persistence; suite red pending UI wiring._)
- ☑ R2312 – Implement operator console templates/JS to satisfy R2311; rerun `./gradlew :rest-api:test`. (_2025-10-08 – Wired TOTP evaluate/replay panels, ensured telemetry surfacing, and confirmed Selenium coverage._)
- ☑ R2321 – Refresh documentation, knowledge map references, and rerun `./gradlew spotlessApply check` plus `qualityGate`. (_2025-10-08 – Docs synced and gates remained green._)
- ☑ R2322 – Add failing Selenium assertions enforcing inline-before-stored ordering for TOTP mode selectors. (_2025-10-08 – Selenium run failed pre-change, locking UI expectations._)
- ☑ R2323 – Reorder TOTP console markup to satisfy R2322 and rerun Selenium alongside `./gradlew spotlessApply check`. (_2025-10-08 – Updated radio markup; suite now green._)
- ☑ R2324 – Add failing Selenium assertions verifying inline parameter controls share a single row. (_2025-10-08 – Added guard to Selenium suite; run failed before layout update._)
- ☑ R2325 – Adjust templates/CSS to satisfy R2324 and rerun Selenium plus `./gradlew spotlessApply check`. (_2025-10-08 – Introduced `totp-inline-parameter-grid`; all checks green._)
- ☑ R2326 – Add failing Selenium assertions ensuring drift backward/forward controls align on a single row. (_2025-10-08 – Guard failed pre-change, confirming expectation._)
- ☑ R2327 – Update templates/CSS to satisfy R2326 and rerun Selenium plus `./gradlew spotlessApply check`. (_2025-10-08 – Added `totp-drift-grid`; Selenium suite now green._)
- ☑ R2328 – Stage failing application/service, REST, and UI tests for a TOTP stored-mode `Seed sample credentials` control and seeding endpoint (empty-store prompts, telemetry, visibility gating). _(2025-10-09 – Added `TotpSeedApplicationServiceTest`, `TotpTelemetryContractTest`, `TotpCredentialSeedEndpointTest`, and `TotpOperatorUiSeedingSeleniumTest`; confirmed red state via `./gradlew :application:test --tests "io.openauth.sim.application.totp.TotpSeedApplicationServiceTest"`, `./gradlew :rest-api:test --tests "io.openauth.sim.rest.TotpCredentialSeedEndpointTest"`, and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeedingSeleniumTest"`.)_
- ☑ R2329 – Implement the TOTP seeding application service, REST endpoint, operator console button wiring, and documentation updates; rerun `./gradlew spotlessApply check`. _(2025-10-09 – Added `TotpSeedApplicationService`, `TotpCredentialSeedService`/controller, TOTP credential directory summaries, and operator console seed controls backed by `TotpOperatorSampleData`. Updated docs/how-to guide and exercised `./gradlew :application:test --tests "io.openauth.sim.application.totp.TotpSeedApplicationServiceTest"`, `./gradlew :rest-api:test --tests "io.openauth.sim.rest.TotpCredentialSeedEndpointTest"`, `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest"` and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeedingSeleniumTest"`.)_
- ☑ R2330 – Add failing Selenium/UI regression asserting the TOTP inline evaluate and replay panels expose a "Load a sample vector" preset control that populates shared secret, algorithm, digits, step seconds, timestamp, OTP, and drift defaults. (_2025-10-09 – Completed with dedicated Selenium coverage; targeted runs `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest.totpInlineSamplePresetPopulatesForm"` and `...TotpReplaySamplePresetPopulatesForm` now pass._)
- ☑ R2331 – Implement the TOTP inline preset dropdowns and sample dataset in Thymeleaf templates and `ui/totp/console.js`, ensuring telemetry metadata reflects preset usage; rerun `./gradlew :rest-api:test` and `./gradlew spotlessApply check`. (_2025-10-09 – Implemented evaluate/replay preset selects, sample payloads, telemetry metadata enrichment, and JS wiring. Verified via targeted Selenium runs plus `./gradlew spotlessApply check`._)
- ☑ R2332 – Update operator documentation and knowledge map to describe the new TOTP presets; rerun `./gradlew spotlessApply check`. (_2025-10-09 – Refreshed the operator how-to with preset workflows/telemetry notes, expanded the knowledge map entry, and revalidated via `./gradlew spotlessApply check`._)
- ☑ R2333 – Align the TOTP replay result panel with HOTP/OCRA (status badge plus Reason Code/Outcome rows only) and trim Selenium expectations; rerun `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest"` and `./gradlew spotlessApply check`. (_2025-10-09 – Updated templates/JS, adjusted Selenium assertions, and reverified styling parity with the other protocols._)
- ☑ R2334 – Add failing Selenium assertions ensuring the TOTP stored replay form presents a dropdown labelled “Stored credential,” mirroring HOTP/OCRA behaviour. (_2025-10-09 – Extended `TotpOperatorUiSeleniumTest` and `TotpOperatorUiSeedingSeleniumTest` with label/placeholder/disabled-state expectations; `./gradlew :rest-api:test --tests "...storedTotpReplayReturnsMatch"` failed prior to UI updates, locking the regression._)
- ☑ R2335 – Implement the stored replay dropdown, shared credential population, and label/placeholder parity; rerun targeted Selenium suites and `./gradlew spotlessApply check`. (_2025-10-09 – Updated TOTP Thymeleaf markup and `ui/totp/console.js` to share credential caches, disabled empty states, and refreshed copy. Verified via targeted Selenium runs (`storedTotpCredentialEvaluationSucceeds`, `storedTotpReplayReturnsMatch`, `operatorSeedsCanonicalTotpCredentials`) and a full `./gradlew spotlessApply check`.)
- ☑ R2336 – Stage failing coverage for the stored replay “Load sample data” control (application sampler tests, REST endpoint MockMvc/OpenAPI snapshots, and Selenium assertions verifying button visibility + form population). (_2025-10-09 – Added `TotpSampleApplicationServiceTest`, `TotpStoredSampleEndpointTest`, and new Selenium regression. Verified expected red state via `./gradlew :application:test --tests "io.openauth.sim.application.totp.TotpSampleApplicationServiceTest"`, `./gradlew :rest-api:test --tests "io.openauth.sim.rest.TotpStoredSampleEndpointTest"`, and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest"`._)
- ☑ R2337 – Implement the TOTP stored sample application service + REST endpoint (`/api/v1/totp/credentials/{credentialId}/sample`), emit telemetry, refresh OpenAPI snapshots, wire the operator console “Load sample data” UX, and rerun targeted suites alongside `./gradlew spotlessApply check`. (_2025-10-09 – Added `TotpSampleApplicationService`, REST response/telemetry plumbing, and updated `TotpCredentialDirectoryController` + operator UI to consume the new endpoint. Regenerated OpenAPI snapshots via `OPENAPI_SNAPSHOT_WRITE=true ./gradlew :rest-api:test`, reran targeted verifications (`./gradlew :application:test --tests "io.openauth.sim.application.totp.TotpSampleApplicationServiceTest"` and `./gradlew :rest-api:test --tests "io.openauth.sim.rest.TotpStoredSampleEndpointTest" "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest"`), and finished with `./gradlew spotlessApply check`.)_
- ☑ R2338 – Align the HOTP/TOTP stored replay “Load sample data” buttons with the OCRA layout by repositioning them directly beneath the stored credential selector, updating Thymeleaf templates/CSS/JS plus Selenium assertions, and rerunning `./gradlew :rest-api:test` followed by `./gradlew spotlessApply check`. (_2025-10-09 – Moved the stored replay sample controls into the credential column for both protocols, adjusted shared console CSS, and verified via `./gradlew :rest-api:test` and `./gradlew spotlessApply check`._)
- ☑ R2340 – Stage regression coverage that exercises the canonical SHA-512 seeded credential through `TotpSampleApplicationService` and `/api/v1/totp/credentials/{credentialId}/sample`, capturing the current failure surfaced by the operator console. (_2025-10-09 – Added `TotpOperatorSampleDataTest` and an endpoint regression in `TotpStoredSampleEndpointTest`; `./gradlew :rest-api:test --tests "io.openauth.sim.rest.TotpStoredSampleEndpointTest.storedSha512SeedSampleReturnsPayload" --tests "io.openauth.sim.rest.ui.TotpOperatorSampleDataTest"` failed as expected._)
- ☑ R2341 – Update SHA-512 seed metadata/shared secret to satisfy minimum secret length requirements, refresh deterministic OTP expectations, and rerun `./gradlew spotlessApply check`. (_2025-10-09 – Swapped in a 32-byte SHA-512 seed secret, refreshed metadata assertions, then re-ran the targeted tests above and `./gradlew spotlessApply check` to confirm the fix._)
- ☑ R2342 – Add failing Selenium regression verifying the TOTP inline preset spacing matches the HOTP baseline; run `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest.totpInlinePresetSpacingMatchesHotpBaseline"` expecting failure. (_2025-10-11 – Introduced class-parity guard; command surfaced the missing spacing token as a red test prior to template updates._)
- ☑ R2343 – Apply the shared `stack-offset-top-lg` spacing token to the TOTP evaluate and replay inline sections to satisfy R2342; rerun the targeted Selenium suite and `./gradlew spotlessApply check`. (_2025-10-11 – Updated Thymeleaf markup plus Selenium helper retries, re-ran the targeted test to green, then executed `./gradlew spotlessApply check` successfully._)
- ☑ R2344 – Add failing Selenium regression asserting the TOTP Evaluate tab defaults the mode selector to “Inline parameters,” mirroring HOTP/OCRA/FIDO2 behaviour; expect red via `./gradlew :rest-api:test --tests "io.openauth.sim.rest.ui.TotpOperatorUiSeleniumTest.totpEvaluateDefaultsToInline"` prior to implementation. (_2025-10-11 – New test inserted and verified red against existing stored default._)
- ☑ R2345 – Update the operator console templates/JS so the TOTP Evaluate tab selects inline parameters by default and rerun the targeted Selenium suite plus `./gradlew spotlessApply check`. (_2025-10-11 – Adjusted Thymeleaf markup, TOTP/host console scripts, and Selenium expectations; reran `TotpOperatorUiSeleniumTest` plus `./gradlew spotlessApply check` to confirm green state._)

## Analysis Gate
- 2025-10-08 – Completed checklist 1–6; plan/spec/tasks align, open-question log cleared, and no remediation required before development.
