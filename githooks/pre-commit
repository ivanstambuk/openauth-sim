#!/usr/bin/env bash
set -euo pipefail

# -----------------------------------------------------------------------------
# Pre-commit quality gate for OpenAuth Simulator
#   1. Collect staged files and verify prerequisites
#   2. Guard against oversized/binary artefacts
#   3. Run Gradle formatting (Palantir Java Format 2.78.0) + targeted tests + check (sans full test suite)
#   4. Execute secret scanning (gitleaks)
# -----------------------------------------------------------------------------

ROOT_DIR=$(git rev-parse --show-toplevel)
MAX_FILE_SIZE_BYTES=$((1024 * 1024)) # 1 MB
LARGE_FILE_EXCEPTIONS=(
  "docs/trust/snapshots/2025-11-15/member-states/de/trusted-list.xml"
  "docs/_assets/app-demo.gif"
)

log() { echo "[pre-commit] $*" >&2; }
die() { log "$*"; exit 1; }
require_command() {
  local binary=$1
  local guidance=$2
  command -v "$binary" >/dev/null 2>&1 || die "$guidance"
}
human_readable_size() {
  local bytes=$1
  if command -v numfmt >/dev/null 2>&1; then
    numfmt --to=iec --suffix=B "$bytes"
  else
    printf '%sB' "$bytes"
  fi
}

ensure_open_questions_guardrail() {
  local file="$ROOT_DIR/docs/4-architecture/open-questions.md"
  [[ -f $file ]] || return

  local resolved_lines
  resolved_lines=$(grep -nE '\|\s*[Rr]esolved\s*\|' "$file" || true)
  if [[ -n $resolved_lines ]]; then
    log "Resolved entries remain in '$file'; remove them before committing."
    printf '%s\n' "$resolved_lines" >&2
    die "Open questions log must only list active items (Status == Open)."
  fi
}

is_file_staged() {
  local target=$1
  for staged in "${STAGED_FILES[@]}"; do
    if [[ $staged == "$target" ]]; then
      return 0
    fi
  done
  return 1
}

verify_gradle_wrapper_jar() {
  local jar_rel_path="gradle/wrapper/gradle-wrapper.jar"
  local checksum_rel_path="gradle/wrapper/gradle-wrapper.jar.sha256"
  local jar_path="$ROOT_DIR/$jar_rel_path"
  local checksum_path="$ROOT_DIR/$checksum_rel_path"

  require_command sha256sum "Install 'sha256sum' (coreutils) to verify Gradle wrapper integrity."

  if ! is_file_staged "$checksum_rel_path"; then
    log "Gradle wrapper jar staged without matching checksum file ('$checksum_rel_path')."
    log "Download the official checksum from services.gradle.org, add it beside the jar, stage both, then retry."
    return 1
  fi

  if [[ ! -f $checksum_path ]]; then
    log "Checksum file '$checksum_rel_path' is missing. Stage the checksum alongside the jar."
    return 1
  fi

  local expected_checksum
  expected_checksum=$(awk '{print $1}' "$checksum_path" | tr -d '\r')
  if [[ -z ${expected_checksum// } ]]; then
    log "Checksum file '$checksum_rel_path' is empty or malformed."
    return 1
  fi

  local actual_checksum
  actual_checksum=$(sha256sum "$jar_path" | awk '{print $1}')

  if [[ "$expected_checksum" != "$actual_checksum" ]]; then
    log "Gradle wrapper checksum mismatch detected."
    log "  expected: $expected_checksum"
    log "  actual:   $actual_checksum"
    log "Regenerate the wrapper via './gradlew wrapper ...' and re-download the matching checksum."
    return 1
  fi

  return 0
}

run_gradle_with_retry() {
  local description=$1
  shift
  local -a gradle_args=("$@")
  log "$description"

  local output=""
  local exit_code=0
  set +e
  output=$("$ROOT_DIR"/gradlew --no-daemon "${gradle_args[@]}" 2>&1)
  exit_code=$?
  set -e
  if [[ -n $output ]]; then
    printf '%s\n' "$output"
  fi

  if (( exit_code == 0 )); then
    return 0
  fi

  local stale_signature='Spotless JVM-local cache is stale. Regenerate the cache with'

  if grep -Fq "$stale_signature" <<<"$output"; then
    local cache_dir="$ROOT_DIR/.gradle/configuration-cache"
    log "Detected Spotless stale cache; removing '$cache_dir' and retrying once."
    rm -rf "$cache_dir"

    set +e
    local retry_output
    local retry_exit=0
    retry_output=$("$ROOT_DIR"/gradlew --no-daemon "${gradle_args[@]}" 2>&1)
    retry_exit=$?
    set -e
    if [[ -n $retry_output ]]; then
      printf '%s\n' "$retry_output"
    fi

    if (( retry_exit == 0 )); then
      log "Spotless retry succeeded after cache clear."
      return 0
    else
      log "Spotless retry failed after cache clear (exit $retry_exit)."
      return $retry_exit
    fi
  fi

  return $exit_code
}

collect_staged_files() {
  mapfile -t STAGED_FILES < <(git diff --cached --name-only --diff-filter=AM)
  if (( ${#STAGED_FILES[@]} == 0 )); then
    log "No staged changes detected; skipping hook."
    exit 0
  fi

  ensure_open_questions_guardrail
}

validate_environment() {
  [[ -n ${JAVA_HOME:-} ]] || die "JAVA_HOME must point to a Java 17 JDK before committing."
  require_command file "Install 'file' command (usually part of util-linux) before committing."
}

is_large_file_exception() {
  local target=$1
  for exception in "${LARGE_FILE_EXCEPTIONS[@]}"; do
    if [[ $target == "$exception" ]]; then
      return 0
    fi
  done
  return 1
}

enforce_staged_file_guards() {
  local -a large_files=()
  local -a binary_files=()
  local file size_bytes mime_type

  for file in "${STAGED_FILES[@]}"; do
    [[ -f "$file" ]] || continue

    size_bytes=$(wc -c <"$file")
    if (( size_bytes > MAX_FILE_SIZE_BYTES )); then
      if is_large_file_exception "$file"; then
        log "Allowing large file exception for $file ($(human_readable_size "$size_bytes"))."
      else
        large_files+=("$file ($(human_readable_size "$size_bytes"))")
      fi
    fi

    if [[ $file == "gradle/wrapper/gradle-wrapper.jar" ]]; then
      verify_gradle_wrapper_jar || die "Gradle wrapper integrity verification failed."
      continue
    fi

    mime_type=$(file -b --mime "$file" 2>/dev/null || echo "application/octet-stream")
    if [[ $mime_type == image/* ]]; then
      continue
    fi
    if [[ $mime_type == application/json* ]]; then
      continue
    fi
    if [[ $mime_type == application/javascript* || $mime_type == text/javascript* ]]; then
      continue
    fi
    if [[ $mime_type == application/x-yaml* || $mime_type == text/yaml* ]]; then
      continue
    fi
    if [[ $mime_type == *"charset=binary"* || $mime_type == application/* ]]; then
      binary_files+=("$file ($mime_type)")
    fi
  done

  if (( ${#large_files[@]} > 0 )); then
    log "The following staged files exceed the 1 MB limit:"
    printf '  - %s\n' "${large_files[@]}" >&2
    die "Remove or split large files before committing."
  fi

  if (( ${#binary_files[@]} > 0 )); then
    log "Binary files detected in the staged changes:"
    printf '  - %s\n' "${binary_files[@]}" >&2
    die "Remove generated artifacts (e.g., .class, .jar) before committing."
  fi
}

enforce_markdown_linewraps() {
  local script="$ROOT_DIR/tools/scripts/check-markdown-linewraps.py"
  [[ -x $script ]] || return

  local -a markdown_files=()
  for file in "${STAGED_FILES[@]}"; do
    [[ $file == *.md ]] && markdown_files+=("$file")
  done

  if (( ${#markdown_files[@]} == 0 )); then
    return
  fi

  log "Checking Markdown list items for manual line wraps"
  if ! "$script" "${markdown_files[@]}"; then
    die "Markdown list entries must stay on one physical line (see errors above)."
  fi
}

clear_configuration_cache() {
  local cache_dir="$ROOT_DIR/.gradle/configuration-cache"
  if [[ -d $cache_dir ]]; then
    log "Clearing Gradle configuration cache before quality pipeline."
    rm -rf "$cache_dir"
  fi
}

run_gradle_pipeline() {
  clear_configuration_cache
  run_gradle_with_retry "Warming Gradle configuration cache" help --configuration-cache

  run_gradle_with_retry "Running Gradle spotlessApply (Palantir Java Format 2.78.0)" spotlessApply

  declare -gA TEST_TASKS=()
  for file in "${STAGED_FILES[@]}"; do
    case "$file" in
      core/src/*) TEST_TASKS[":core:test"]=1 ;;
      cli/src/*) TEST_TASKS[":cli:test"]=1 ;;
      rest-api/src/*) TEST_TASKS[":rest-api:test"]=1 ;;
      ui/src/*) TEST_TASKS[":ui:test"]=1 ;;
    esac
  done

  if (( ${#TEST_TASKS[@]} > 0 )); then
    run_gradle_with_retry "Running targeted test suites: ${!TEST_TASKS[@]}" "${!TEST_TASKS[@]}"
  else
    log "No staged production code changes detected; skipping targeted tests."
  fi

  run_gradle_with_retry "Generating aggregated JaCoCo report" jacocoAggregatedReport
  run_gradle_with_retry "Verifying JaCoCo thresholds" jacocoCoverageVerification

  run_gradle_with_retry \
    "Running Gradle check (skipping heavy coverage tasks)" \
    check -Ppit.skip=true -x test -x jacocoAggregatedReport -x jacocoCoverageVerification
}

run_mutation_suite() {
  run_gradle_with_retry "Running mutation test suite" mutationTest
}

run_external_scanners() {
  require_command gitleaks "Install gitleaks: https://github.com/gitleaks/gitleaks#installation"
  log "Running gitleaks secret scan"
  gitleaks protect --no-banner --redact --staged --source "$ROOT_DIR"

}

main() {
  collect_staged_files
  validate_environment
  enforce_markdown_linewraps
  enforce_staged_file_guards
  run_gradle_pipeline
  run_mutation_suite
  run_external_scanners
  log "All pre-commit checks passed."
}

main "$@"
